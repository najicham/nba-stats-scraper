{% extends "base.html" %}

{% block title %}Dashboard | {{ sport|upper if sport else 'NBA' }} Pipeline Admin{% endblock %}

{% block content %}
<div x-data="{ activeTab: 'today', showActions: false }">

    <!-- Status Cards -->
    <div id="status-cards"
         hx-get="/partials/status-cards?sport={{ sport or 'nba' }}"
         hx-trigger="refresh"
         hx-swap="innerHTML">
        {% include "components/status_cards.html" %}
    </div>

    <!-- Tab Navigation -->
    <div class="mt-8 border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
            <button
                @click="activeTab = 'today'"
                :class="activeTab === 'today' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Today's Games
            </button>
            <button
                @click="activeTab = 'tomorrow'"
                :class="activeTab === 'tomorrow' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Tomorrow's Games
            </button>
            <button
                @click="activeTab = 'errors'"
                :class="activeTab === 'errors' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Recent Errors
                {% if recent_errors|length > 0 %}
                <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full">{{ recent_errors|length }}</span>
                {% endif %}
            </button>
            <button
                @click="activeTab = 'schedulers'"
                :class="activeTab === 'schedulers' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Scheduler History
            </button>
            <button
                @click="activeTab = 'history'"
                :class="activeTab === 'history' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Extended History
            </button>
            <button
                @click="activeTab = 'failures'"
                :class="activeTab === 'failures' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Processor Failures
            </button>
            <button
                @click="activeTab = 'coverage'"
                :class="activeTab === 'coverage' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Coverage Metrics
            </button>
            <button
                @click="activeTab = 'calibration'"
                :class="activeTab === 'calibration' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Calibration
            </button>
            <button
                @click="activeTab = 'roi'"
                :class="activeTab === 'roi' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                ROI Analysis
            </button>
            <button
                @click="activeTab = 'players'"
                :class="activeTab === 'players' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Player Insights
            </button>
            <button
                @click="activeTab = 'reliability'"
                :class="activeTab === 'reliability' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Reliability
                {% if reliability_gaps is defined and reliability_gaps > 0 %}
                <span class="ml-2 px-2 py-0.5 bg-orange-100 text-orange-600 text-xs rounded-full">{{ reliability_gaps }}</span>
                {% endif %}
            </button>
            <button
                @click="activeTab = 'trends'"
                :class="activeTab === 'trends' ? 'border-cyan-500 text-cyan-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Trends
            </button>
            <button
                @click="activeTab = 'timeline'"
                :class="activeTab === 'timeline' ? 'border-violet-500 text-violet-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Pipeline Timeline
            </button>
            <button
                @click="activeTab = 'validation'"
                :class="activeTab === 'validation' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
            >
                Validation
            </button>
        </nav>
    </div>

    <!-- Tab Content -->
    <div class="mt-6">
        <!-- Today's Games Tab -->
        <div x-show="activeTab === 'today'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        {{ 'Pitchers' if sport == 'mlb' else 'Games' }} for {{ today }} (Today)
                    </h3>
                    <button
                        hx-get="/partials/games-table/{{ today }}?sport={{ sport or 'nba' }}"
                        hx-target="#today-games-table"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="today-games-table"
                     hx-get="/partials/games-table/{{ today }}?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading {{ 'pitchers' if sport == 'mlb' else 'games' }}...</div>
                </div>
            </div>
        </div>

        <!-- Tomorrow's Games Tab -->
        <div x-show="activeTab === 'tomorrow'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        {{ 'Pitchers' if sport == 'mlb' else 'Games' }} for {{ tomorrow }} (Tomorrow)
                    </h3>
                    <div class="flex space-x-2">
                        <button
                            hx-get="/partials/games-table/{{ tomorrow }}?sport={{ sport or 'nba' }}"
                            hx-target="#tomorrow-games-table"
                            hx-swap="innerHTML"
                            class="text-sm text-blue-600 hover:text-blue-800"
                        >
                            Refresh
                        </button>
                        <button
                            @click="showActions = !showActions"
                            class="text-sm bg-orange-100 text-orange-700 px-3 py-1 rounded hover:bg-orange-200"
                        >
                            Actions
                        </button>
                    </div>
                </div>

                <!-- Action Buttons (hidden by default) -->
                <div x-show="showActions" x-cloak class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800 mb-3">Force data regeneration for tomorrow:</p>
                    <div class="flex space-x-2">
                        <button
                            hx-post="/api/actions/retry-phase"
                            hx-vals='{"date": "{{ tomorrow }}", "phase": "phase3", "sport": "{{ sport or 'nba' }}"}'
                            hx-confirm="Retry Phase 3 ({{ 'analytics' if sport == 'mlb' else 'context generation' }}) for {{ tomorrow }}?"
                            class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                        >
                            Retry Phase 3
                        </button>
                        <button
                            hx-post="/api/actions/retry-phase"
                            hx-vals='{"date": "{{ tomorrow }}", "phase": "phase4", "sport": "{{ sport or 'nba' }}"}'
                            hx-confirm="Retry Phase 4 ({{ 'precompute' if sport == 'mlb' else 'ML features' }}) for {{ tomorrow }}?"
                            class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                        >
                            Retry Phase 4
                        </button>
                        <button
                            hx-post="/api/actions/force-predictions"
                            hx-vals='{"date": "{{ tomorrow }}", "sport": "{{ sport or 'nba' }}"}'
                            hx-confirm="Force predictions for {{ tomorrow }}? This will regenerate all predictions."
                            class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600"
                        >
                            Force Predictions
                        </button>
                    </div>
                </div>

                <div id="tomorrow-games-table"
                     hx-get="/partials/games-table/{{ tomorrow }}?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading {{ 'pitchers' if sport == 'mlb' else 'games' }}...</div>
                </div>
            </div>
        </div>

        <!-- Errors Tab -->
        <div x-show="activeTab === 'errors'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Recent Errors (Last 6 Hours)</h3>
                    <button
                        hx-get="/partials/error-feed?sport={{ sport or 'nba' }}"
                        hx-target="#error-feed"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="error-feed"
                     hx-get="/partials/error-feed?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading errors...</div>
                </div>
            </div>
        </div>

        <!-- Schedulers Tab -->
        <div x-show="activeTab === 'schedulers'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Scheduler History (Last 12 Hours)</h3>
                <div id="scheduler-timeline"
                     hx-get="/api/schedulers?sport={{ sport or 'nba' }}"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="text-gray-500 text-center py-8">Loading scheduler history...</div>
                </div>
            </div>
        </div>

        <!-- Extended History Tab -->
        <div x-show="activeTab === 'history'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Extended Pipeline History</h3>
                    <button
                        hx-get="/partials/extended-history?sport={{ sport or 'nba' }}&days=7"
                        hx-target="#extended-history-content"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="extended-history-content"
                     hx-get="/partials/extended-history?sport={{ sport or 'nba' }}&days=7"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading extended history...</div>
                </div>
            </div>
        </div>

        <!-- Processor Failures Tab -->
        <div x-show="activeTab === 'failures'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Processor Failures (Last 24 Hours)</h3>
                    <button
                        hx-get="/partials/processor-failures?sport={{ sport or 'nba' }}"
                        hx-target="#processor-failures"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="processor-failures"
                     hx-get="/partials/processor-failures?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading processor failures...</div>
                </div>
            </div>
        </div>

        <!-- Coverage Metrics Tab -->
        <div x-show="activeTab === 'coverage'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Coverage & Grading Metrics</h3>
                    <button
                        hx-get="/partials/coverage-metrics?sport={{ sport or 'nba' }}"
                        hx-target="#coverage-metrics"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="coverage-metrics"
                     hx-get="/partials/coverage-metrics?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading coverage metrics...</div>
                </div>
            </div>
        </div>

        <!-- Calibration Tab -->
        <div x-show="activeTab === 'calibration'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Confidence Calibration Analysis</h3>
                    <button
                        hx-get="/partials/calibration?sport={{ sport or 'nba' }}&days=7"
                        hx-target="#calibration-content"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="calibration-content"
                     hx-get="/partials/calibration?sport={{ sport or 'nba' }}&days=7"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading calibration data...</div>
                </div>
            </div>
        </div>

        <!-- ROI Analysis Tab -->
        <div x-show="activeTab === 'roi'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">ROI Betting Simulation</h3>
                    <button
                        hx-get="/partials/roi?sport={{ sport or 'nba' }}&days=16"
                        hx-target="#roi-content"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="roi-content"
                     hx-get="/partials/roi?sport={{ sport or 'nba' }}&days=16"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading ROI data...</div>
                </div>
            </div>
        </div>

        <!-- Player Insights Tab -->
        <div x-show="activeTab === 'players'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Player Predictability Analysis</h3>
                    <button
                        hx-get="/partials/player-insights?sport={{ sport or 'nba' }}"
                        hx-target="#player-insights-content"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="player-insights-content"
                     hx-get="/partials/player-insights?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading player insights...</div>
                </div>
            </div>
        </div>

        <!-- Reliability Tab (R-006, R-007, R-008) -->
        <div x-show="activeTab === 'reliability'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Pipeline Reliability Monitoring</h3>
                    <button
                        hx-get="/partials/reliability-tab?sport={{ sport or 'nba' }}"
                        hx-target="#reliability-content"
                        hx-swap="innerHTML"
                        class="text-sm text-blue-600 hover:text-blue-800"
                    >
                        Refresh
                    </button>
                </div>
                <div id="reliability-content"
                     hx-get="/partials/reliability-tab?sport={{ sport or 'nba' }}"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading reliability data...</div>
                </div>
            </div>
        </div>

        <!-- Trends Tab -->
        <div x-show="activeTab === 'trends'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Pipeline Trend Charts</h3>
                    <div class="flex items-center space-x-4">
                        <select id="trends-days-select" class="text-sm border-gray-300 rounded-md">
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="60">Last 60 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <button
                            id="refresh-trends-btn"
                            class="text-sm text-blue-600 hover:text-blue-800"
                        >
                            Refresh
                        </button>
                    </div>
                </div>
                <div id="trends-content">
                    <div class="text-gray-500 text-center py-8">Loading trend charts...</div>
                </div>
            </div>
        </div>

        <!-- Pipeline Timeline Tab -->
        <div x-show="activeTab === 'timeline'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Pipeline Event Timeline</h3>
                    <div class="flex items-center space-x-4">
                        <input
                            type="date"
                            id="timeline-date"
                            class="text-sm border-gray-300 rounded-md"
                            value="{{ today }}"
                        >
                        <select id="timeline-hours" class="text-sm border-gray-300 rounded-md">
                            <option value="6">Last 6 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24" selected>Last 24 hours</option>
                            <option value="48">Last 48 hours</option>
                        </select>
                        <button
                            id="refresh-timeline-btn"
                            class="text-sm text-blue-600 hover:text-blue-800"
                        >
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Correlation ID Trace Section -->
                <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-700">Correlation ID Trace</h4>
                        <span class="text-xs text-gray-500">Trace a request through the pipeline</span>
                    </div>
                    <div class="flex space-x-3">
                        <div class="flex-1 relative">
                            <input
                                type="text"
                                id="correlation-id-input"
                                placeholder="Enter correlation ID (e.g., abc12345-6789-...)"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md font-mono focus:ring-2 focus:ring-violet-500 focus:border-violet-500"
                                minlength="8"
                            >
                            <div id="correlation-suggestions" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg hidden max-h-48 overflow-y-auto"></div>
                        </div>
                        <button
                            id="trace-correlation-btn"
                            class="px-4 py-2 bg-violet-600 text-white text-sm font-medium rounded-md hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500"
                        >
                            Trace
                        </button>
                        <button
                            id="clear-trace-btn"
                            class="px-3 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300"
                            title="Clear trace"
                        >
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Correlation Trace Results -->
                <div id="correlation-trace-result" class="mb-6 hidden">
                    <!-- Results will be loaded here via HTMX -->
                </div>

                <div id="pipeline-timeline"
                     hx-get="/partials/pipeline-timeline?hours=24"
                     hx-trigger="load">
                    <div class="text-gray-500 text-center py-8">Loading pipeline timeline...</div>
                </div>
            </div>
        </div>

        <!-- Validation Tab -->
        <div x-show="activeTab === 'validation'" x-cloak>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Data Quality Validation</h3>
                    <div class="flex items-center space-x-4">
                        <select id="validation-days-select" class="text-sm border-gray-300 rounded-md">
                            <option value="3">Last 3 days</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30">Last 30 days</option>
                        </select>
                        <button
                            id="refresh-validation-btn"
                            class="text-sm text-blue-600 hover:text-blue-800"
                        >
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Validation Summary Metrics -->
                <div id="validation-summary-metrics" class="mb-6">
                    <div class="text-gray-500 text-center py-4">Loading validation summary...</div>
                </div>

                <!-- Validation Sections -->
                <div class="space-y-6">
                    <!-- Validation Summary Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700">Validation Summary</h4>
                        </div>
                        <div id="validation-summary-content" class="p-4">
                            <div class="text-gray-500 text-center py-4">Loading...</div>
                        </div>
                    </div>

                    <!-- DNP Voiding Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700">DNP Voiding Status</h4>
                        </div>
                        <div id="dnp-voiding-content" class="p-4">
                            <div class="text-gray-500 text-center py-4">Loading...</div>
                        </div>
                    </div>

                    <!-- Prediction Integrity Section -->
                    <div class="border border-gray-200 rounded-lg">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700">Prediction Integrity</h4>
                        </div>
                        <div id="prediction-integrity-content" class="p-4">
                            <div class="text-gray-500 text-center py-4">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Timeline refresh handler
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refresh-timeline-btn');
    const dateInput = document.getElementById('timeline-date');
    const hoursSelect = document.getElementById('timeline-hours');
    const timelineDiv = document.getElementById('pipeline-timeline');

    if (refreshBtn && timelineDiv) {
        refreshBtn.addEventListener('click', function() {
            const date = dateInput?.value || '';
            const hours = hoursSelect?.value || '24';
            const url = date
                ? `/partials/pipeline-timeline?date=${date}`
                : `/partials/pipeline-timeline?hours=${hours}`;
            htmx.ajax('GET', url, {target: '#pipeline-timeline', swap: 'innerHTML'});
        });
    }

    // Correlation ID Trace handlers
    const correlationInput = document.getElementById('correlation-id-input');
    const traceBtn = document.getElementById('trace-correlation-btn');
    const clearBtn = document.getElementById('clear-trace-btn');
    const traceResult = document.getElementById('correlation-trace-result');
    const suggestions = document.getElementById('correlation-suggestions');

    if (traceBtn && correlationInput) {
        // Trace button click
        traceBtn.addEventListener('click', function() {
            const correlationId = correlationInput.value.trim();
            if (correlationId.length >= 8) {
                loadCorrelationTrace(correlationId);
            } else {
                showTraceMessage('Please enter at least 8 characters', 'warning');
            }
        });

        // Enter key in input
        correlationInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                traceBtn.click();
            }
        });

        // Clear button
        clearBtn?.addEventListener('click', function() {
            correlationInput.value = '';
            traceResult.classList.add('hidden');
            traceResult.innerHTML = '';
            suggestions.classList.add('hidden');
        });

        // Autocomplete/suggestions on input
        let searchTimeout;
        correlationInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length >= 4) {
                searchTimeout = setTimeout(() => {
                    searchCorrelationIds(query);
                }, 300);
            } else {
                suggestions.classList.add('hidden');
            }
        });

        // Click on suggestion
        suggestions.addEventListener('click', function(e) {
            const item = e.target.closest('.correlation-suggestion');
            if (item) {
                const correlationId = item.dataset.correlationId;
                correlationInput.value = correlationId;
                suggestions.classList.add('hidden');
                loadCorrelationTrace(correlationId);
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!correlationInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }

    // Make correlation IDs in timeline clickable
    document.body.addEventListener('click', function(e) {
        const target = e.target.closest('[data-correlation-id]');
        if (target && correlationInput) {
            const correlationId = target.dataset.correlationId;
            correlationInput.value = correlationId;
            loadCorrelationTrace(correlationId);
            // Scroll to trace result
            traceResult?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

function loadCorrelationTrace(correlationId) {
    const traceResult = document.getElementById('correlation-trace-result');
    if (!traceResult) return;

    traceResult.classList.remove('hidden');
    traceResult.innerHTML = '<div class="text-gray-500 text-center py-8">Loading trace...</div>';

    htmx.ajax('GET', `/partials/correlation-trace?id=${encodeURIComponent(correlationId)}`, {
        target: '#correlation-trace-result',
        swap: 'innerHTML'
    });
}

function searchCorrelationIds(query) {
    const suggestions = document.getElementById('correlation-suggestions');
    if (!suggestions) return;

    fetch(`/api/correlation-search?q=${encodeURIComponent(query)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                let html = '';
                data.results.forEach(item => {
                    const statusClass = item.has_error ? 'text-red-600' : 'text-green-600';
                    const statusIcon = item.has_error ? '!' : '&#10003;';
                    html += `
                        <div class="correlation-suggestion px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0"
                             data-correlation-id="${item.correlation_id}">
                            <div class="flex items-center justify-between">
                                <span class="font-mono text-sm text-gray-800">${item.correlation_id.substring(0, 20)}...</span>
                                <span class="${statusClass} text-xs">${statusIcon}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">
                                ${item.event_count} events &bull; ${item.phases.join(', ')}
                            </div>
                        </div>
                    `;
                });
                suggestions.innerHTML = html;
                suggestions.classList.remove('hidden');
            } else {
                suggestions.classList.add('hidden');
            }
        })
        .catch(err => {
            console.error('Search error:', err);
            suggestions.classList.add('hidden');
        });
}

function showTraceMessage(message, type) {
    const traceResult = document.getElementById('correlation-trace-result');
    if (!traceResult) return;

    const bgClass = type === 'warning' ? 'bg-yellow-50 text-yellow-700' : 'bg-gray-50 text-gray-600';
    traceResult.classList.remove('hidden');
    traceResult.innerHTML = `<div class="text-center py-4 ${bgClass} rounded-lg">${message}</div>`;
}

// Heartbeat refresh handler
document.addEventListener('DOMContentLoaded', function() {
    const refreshHeartbeatsBtn = document.getElementById('refresh-heartbeats-btn');
    const heartbeatHoursSelect = document.getElementById('heartbeat-hours-select');

    if (refreshHeartbeatsBtn) {
        refreshHeartbeatsBtn.addEventListener('click', function() {
            const hours = heartbeatHoursSelect?.value || '24';
            htmx.ajax('GET', `/partials/heartbeat-timeline?hours=${hours}`, {
                target: '#heartbeat-content',
                swap: 'innerHTML'
            });
        });
    }

    if (heartbeatHoursSelect) {
        heartbeatHoursSelect.addEventListener('change', function() {
            const hours = this.value;
            htmx.ajax('GET', `/partials/heartbeat-timeline?hours=${hours}`, {
                target: '#heartbeat-content',
                swap: 'innerHTML'
            });
        });
    }
});

// =========================================================================
// Validation Tab Functionality
// =========================================================================

document.addEventListener('DOMContentLoaded', function() {
    const refreshValidationBtn = document.getElementById('refresh-validation-btn');
    const validationDaysSelect = document.getElementById('validation-days-select');

    // Watch for validation tab activation
    const validationObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const validationTab = document.querySelector('[x-show="activeTab === \'validation\'"]');
                if (validationTab && validationTab.style.display !== 'none') {
                    loadValidationData();
                }
            }
        });
    });

    const validationTabDiv = document.querySelector('[x-show="activeTab === \'validation\'"]');
    if (validationTabDiv) {
        validationObserver.observe(validationTabDiv, { attributes: true });
    }

    // Refresh button handler
    if (refreshValidationBtn) {
        refreshValidationBtn.addEventListener('click', function() {
            loadValidationData();
        });
    }

    // Days select handler
    if (validationDaysSelect) {
        validationDaysSelect.addEventListener('change', function() {
            loadValidationData();
        });
    }
});

async function loadValidationData() {
    const daysSelect = document.getElementById('validation-days-select');
    const days = daysSelect ? daysSelect.value : 7;

    // Load all three endpoints in parallel
    const [summaryData, dnpData, integrityData] = await Promise.all([
        fetchValidationEndpoint(`/api/data-quality/validation-summary?days=${days}`),
        fetchValidationEndpoint(`/api/data-quality/dnp-voiding?days=${days}`),
        fetchValidationEndpoint(`/api/data-quality/prediction-integrity?days=${days}`)
    ]);

    // Render summary metrics at top
    renderValidationSummaryMetrics(summaryData, dnpData, integrityData);

    // Render each section
    renderValidationSummary(summaryData);
    renderDnpVoiding(dnpData);
    renderPredictionIntegrity(integrityData);
}

async function fetchValidationEndpoint(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error(`Error fetching ${url}:`, error);
        return { error: error.message };
    }
}

function getStatusBadge(status) {
    const statusUpper = (status || '').toUpperCase();
    if (statusUpper === 'PASS' || statusUpper === 'OK') {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">PASS</span>';
    } else if (statusUpper === 'WARN' || statusUpper === 'WARNING') {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">WARN</span>';
    } else if (statusUpper === 'FAIL' || statusUpper === 'ERROR') {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">FAIL</span>';
    }
    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">' + (status || 'N/A') + '</span>';
}

function renderValidationSummaryMetrics(summaryData, dnpData, integrityData) {
    const container = document.getElementById('validation-summary-metrics');
    if (!container) return;

    // Calculate overall status
    let passCount = 0;
    let warnCount = 0;
    let failCount = 0;

    const countStatus = (data) => {
        if (!data || data.error) return;
        const results = data.results || data.daily_results || [];
        results.forEach(r => {
            const status = (r.status || r.overall_status || '').toUpperCase();
            if (status === 'PASS' || status === 'OK') passCount++;
            else if (status === 'WARN' || status === 'WARNING') warnCount++;
            else if (status === 'FAIL' || status === 'ERROR') failCount++;
        });
    };

    countStatus(summaryData);
    countStatus(dnpData);
    countStatus(integrityData);

    const total = passCount + warnCount + failCount;
    const passRate = total > 0 ? ((passCount / total) * 100).toFixed(1) : 0;

    // Determine overall health
    let healthStatus = 'PASS';
    let healthBg = 'bg-green-50';
    let healthText = 'text-green-600';
    if (failCount > 0) {
        healthStatus = 'FAIL';
        healthBg = 'bg-red-50';
        healthText = 'text-red-600';
    } else if (warnCount > 0) {
        healthStatus = 'WARN';
        healthBg = 'bg-yellow-50';
        healthText = 'text-yellow-600';
    }

    container.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="${healthBg} rounded-lg p-4 text-center">
                <div class="text-2xl font-bold ${healthText}">${healthStatus}</div>
                <div class="text-sm text-gray-600">Overall Health</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600">${passCount}</div>
                <div class="text-sm text-gray-600">Passed</div>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600">${warnCount}</div>
                <div class="text-sm text-gray-600">Warnings</div>
            </div>
            <div class="bg-red-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600">${failCount}</div>
                <div class="text-sm text-gray-600">Failed</div>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600">${passRate}%</div>
                <div class="text-sm text-gray-600">Pass Rate</div>
            </div>
        </div>
    `;
}

function renderValidationSummary(data) {
    const container = document.getElementById('validation-summary-content');
    if (!container) return;

    if (data.error) {
        container.innerHTML = `<div class="text-red-500 text-center py-4">Error loading data: ${data.error}</div>`;
        return;
    }

    const results = data.results || data.daily_results || [];
    if (results.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No validation data available</div>';
        return;
    }

    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Games</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Predictions</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Graded</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Coverage</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Issues</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

    results.forEach(r => {
        const coverage = r.coverage_pct !== undefined ? r.coverage_pct.toFixed(1) + '%' : 'N/A';
        const issues = r.issues || r.issue_count || 0;
        html += `
            <tr>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${r.game_date || r.date}</td>
                <td class="px-4 py-3 text-sm">${getStatusBadge(r.status || r.overall_status)}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.games || r.game_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.predictions || r.prediction_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.graded || r.graded_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${coverage}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${issues}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function renderDnpVoiding(data) {
    const container = document.getElementById('dnp-voiding-content');
    if (!container) return;

    if (data.error) {
        container.innerHTML = `<div class="text-red-500 text-center py-4">Error loading data: ${data.error}</div>`;
        return;
    }

    const results = data.results || data.daily_results || [];
    if (results.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No DNP voiding data available</div>';
        return;
    }

    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">DNP Players</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Voided</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pending</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Void Rate</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

    results.forEach(r => {
        const voidRate = r.void_rate_pct !== undefined ? r.void_rate_pct.toFixed(1) + '%' :
                        (r.voided && r.dnp_players ? ((r.voided / r.dnp_players) * 100).toFixed(1) + '%' : 'N/A');
        html += `
            <tr>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${r.game_date || r.date}</td>
                <td class="px-4 py-3 text-sm">${getStatusBadge(r.status || r.overall_status)}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.dnp_players || r.dnp_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.voided || r.voided_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.pending || r.pending_count || 0}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${voidRate}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function renderPredictionIntegrity(data) {
    const container = document.getElementById('prediction-integrity-content');
    if (!container) return;

    if (data.error) {
        container.innerHTML = `<div class="text-red-500 text-center py-4">Error loading data: ${data.error}</div>`;
        return;
    }

    const results = data.results || data.daily_results || [];
    if (results.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">No prediction integrity data available</div>';
        return;
    }

    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valid</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Missing Fields</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duplicates</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Integrity %</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

    results.forEach(r => {
        const integrityPct = r.integrity_pct !== undefined ? r.integrity_pct.toFixed(1) + '%' :
                           (r.valid && r.total ? ((r.valid / r.total) * 100).toFixed(1) + '%' : 'N/A');
        html += `
            <tr>
                <td class="px-4 py-3 text-sm font-medium text-gray-900">${r.game_date || r.date}</td>
                <td class="px-4 py-3 text-sm">${getStatusBadge(r.status || r.overall_status)}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.total || r.total_predictions || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.valid || r.valid_count || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.missing_fields || r.missing_field_count || 0}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${r.duplicates || r.duplicate_count || 0}</td>
                <td class="px-4 py-3 text-sm text-gray-500">${integrityPct}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
}
</script>
{% endblock %}

{% block scripts %}
<script>
    // Handle scheduler timeline response
    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        if (evt.detail.target.id === 'scheduler-timeline') {
            const data = JSON.parse(evt.detail.xhr.responseText);
            renderSchedulerTimeline(data.schedulers || []);
        }
        if (evt.detail.target.id === 'history-table') {
            const data = JSON.parse(evt.detail.xhr.responseText);
            renderHistoryTable(data.history || []);
        }
    });

    function renderSchedulerTimeline(schedulers) {
        const container = document.getElementById('scheduler-timeline');
        if (!schedulers.length) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No scheduler runs in the last 12 hours</p>';
            return;
        }

        let html = '<div class="space-y-2">';
        schedulers.forEach(s => {
            const statusClass = s.status === 'success' ? 'bg-green-100 text-green-800' :
                               s.status === 'error' ? 'bg-red-100 text-red-800' :
                               'bg-blue-100 text-blue-800';
            const time = new Date(s.timestamp).toLocaleTimeString('en-US', {
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit'
            });
            html += `
                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="px-2 py-1 text-xs rounded ${statusClass}">${s.status}</span>
                        <span class="font-mono text-sm">${s.job_id}</span>
                    </div>
                    <span class="text-sm text-gray-500">${time} ET</span>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function renderHistoryTable(history) {
        const container = document.getElementById('history-table');
        if (!history.length) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No history available</p>';
            return;
        }

        let html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Games</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Context</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Features</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Predictions</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        history.forEach(h => {
            const statusClass = h.pipeline_status === 'COMPLETE' ? 'bg-green-100 text-green-800' :
                               h.pipeline_status.includes('PENDING') ? 'bg-yellow-100 text-yellow-800' :
                               'bg-gray-100 text-gray-600';
            html += `
                <tr>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${h.game_date}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${h.games_scheduled}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${h.phase3_context}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${h.phase4_features}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${h.predictions}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded ${statusClass}">${h.pipeline_status}</span>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // =========================================================================
    // Trend Charts Functionality
    // =========================================================================

    // Store chart instances for cleanup
    let trendCharts = {
        accuracy: null,
        latency: null,
        errors: null,
        volume: null
    };

    // Initialize trends tab when shown
    document.addEventListener('alpine:init', () => {
        Alpine.effect(() => {
            const activeTab = Alpine.store('activeTab');
            // This will be called when activeTab changes
        });
    });

    // Listen for tab changes via Alpine.js
    document.addEventListener('DOMContentLoaded', function() {
        // Watch for trends tab activation
        const trendsObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const trendsTab = document.querySelector('[x-show="activeTab === \'trends\'"]');
                    if (trendsTab && trendsTab.style.display !== 'none') {
                        loadTrendCharts();
                    }
                }
            });
        });

        const trendsTabDiv = document.querySelector('[x-show="activeTab === \'trends\'"]');
        if (trendsTabDiv) {
            trendsObserver.observe(trendsTabDiv, { attributes: true });
        }

        // Refresh button handler
        document.getElementById('refresh-trends-btn')?.addEventListener('click', function() {
            loadTrendCharts();
        });

        // Days select handler
        document.getElementById('trends-days-select')?.addEventListener('change', function() {
            loadTrendCharts();
        });
    });

    async function loadTrendCharts() {
        const container = document.getElementById('trends-content');
        const daysSelect = document.getElementById('trends-days-select');
        const days = daysSelect ? daysSelect.value : 30;

        container.innerHTML = '<div class="text-gray-500 text-center py-8">Loading trend data...</div>';

        try {
            const response = await fetch(`/api/trends/all?days=${days}`);
            if (!response.ok) throw new Error('Failed to fetch trend data');

            const data = await response.json();
            renderTrendCharts(data, container);
        } catch (error) {
            console.error('Error loading trends:', error);
            container.innerHTML = `<div class="text-red-500 text-center py-8">Error loading trend data: ${error.message}</div>`;
        }
    }

    function renderTrendCharts(data, container) {
        // Create chart container layout
        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Prediction Accuracy Chart -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Prediction Accuracy Over Time</h4>
                    <div style="height: 300px;">
                        <canvas id="accuracy-chart"></canvas>
                    </div>
                </div>

                <!-- Data Volume Chart -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Data Volume Over Time</h4>
                    <div style="height: 300px;">
                        <canvas id="volume-chart"></canvas>
                    </div>
                </div>

                <!-- Error Rate Chart -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Pipeline Error Rate</h4>
                    <div style="height: 300px;">
                        <canvas id="errors-chart"></canvas>
                    </div>
                </div>

                <!-- Pipeline Latency Chart -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">Pipeline Latency (avg seconds)</h4>
                    <div style="height: 300px;">
                        <canvas id="latency-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4" id="trend-summary-stats"></div>
        `;

        // Destroy existing charts
        Object.keys(trendCharts).forEach(key => {
            if (trendCharts[key]) {
                trendCharts[key].destroy();
                trendCharts[key] = null;
            }
        });

        // Create charts
        createAccuracyChart(data.accuracy);
        createVolumeChart(data.volume);
        createErrorsChart(data.errors);
        createLatencyChart(data.latency);
        renderTrendSummary(data);
    }

    function createAccuracyChart(accuracyData) {
        const ctx = document.getElementById('accuracy-chart');
        if (!ctx || !accuracyData || !accuracyData.length) return;

        const labels = accuracyData.map(d => d.date);
        const accuracyValues = accuracyData.map(d => d.accuracy_pct);
        const highConfValues = accuracyData.map(d => d.high_conf_accuracy_pct);

        trendCharts.accuracy = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Overall Accuracy %',
                        data: accuracyValues,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'High Confidence Accuracy %',
                        data: highConfValues,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 30,
                        max: 100,
                        title: { display: true, text: 'Accuracy %' }
                    },
                    x: {
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });
    }

    function createVolumeChart(volumeData) {
        const ctx = document.getElementById('volume-chart');
        if (!ctx || !volumeData || !volumeData.length) return;

        const labels = volumeData.map(d => d.date);
        const games = volumeData.map(d => d.games);
        const predictions = volumeData.map(d => d.predictions);
        const graded = volumeData.map(d => d.graded);

        trendCharts.volume = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Games',
                        data: games,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Predictions',
                        data: predictions,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Graded',
                        data: graded,
                        backgroundColor: 'rgba(249, 115, 22, 0.7)',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Games' },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Predictions' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    function createErrorsChart(errorsData) {
        const ctx = document.getElementById('errors-chart');
        if (!ctx || !errorsData || !errorsData.length) return;

        const labels = errorsData.map(d => d.date);
        const errorRates = errorsData.map(d => d.error_rate_pct);
        const failedRuns = errorsData.map(d => d.failed_runs);

        trendCharts.errors = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Error Rate %',
                        data: errorRates,
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.3,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Failed Runs',
                        data: failedRuns,
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: 'rgba(249, 115, 22, 0.5)',
                        type: 'bar',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Error Rate %' },
                        beginAtZero: true,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Failed Runs' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }

    function createLatencyChart(latencyData) {
        const ctx = document.getElementById('latency-chart');
        if (!ctx || !latencyData || !latencyData.length) return;

        // Group by date and phase
        const phases = [...new Set(latencyData.map(d => d.phase))].filter(p => p);
        const dates = [...new Set(latencyData.map(d => d.date))].sort();

        // Create datasets per phase
        const colors = {
            'phase3': 'rgb(59, 130, 246)',
            'phase4': 'rgb(16, 185, 129)',
            'phase5': 'rgb(249, 115, 22)',
            'raw': 'rgb(139, 92, 246)',
            'analytics': 'rgb(236, 72, 153)'
        };

        const datasets = phases.slice(0, 5).map(phase => {
            const phaseData = latencyData.filter(d => d.phase === phase);
            const dataByDate = {};
            phaseData.forEach(d => { dataByDate[d.date] = d.avg_duration_sec; });

            return {
                label: phase || 'Unknown',
                data: dates.map(date => dataByDate[date] || null),
                borderColor: colors[phase] || 'rgb(107, 114, 128)',
                backgroundColor: 'transparent',
                tension: 0.3
            };
        });

        trendCharts.latency = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 15 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Avg Duration (s)' }
                    },
                    x: {
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });
    }

    function renderTrendSummary(data) {
        const container = document.getElementById('trend-summary-stats');
        if (!container) return;

        // Calculate summary stats
        const accuracy = data.accuracy || [];
        const volume = data.volume || [];
        const errors = data.errors || [];

        const avgAccuracy = accuracy.length > 0
            ? (accuracy.reduce((sum, d) => sum + (d.accuracy_pct || 0), 0) / accuracy.length).toFixed(1)
            : 'N/A';

        const totalPredictions = volume.reduce((sum, d) => sum + (d.predictions || 0), 0);
        const totalGraded = volume.reduce((sum, d) => sum + (d.graded || 0), 0);

        const avgErrorRate = errors.length > 0
            ? (errors.reduce((sum, d) => sum + (d.error_rate_pct || 0), 0) / errors.length).toFixed(2)
            : 'N/A';

        container.innerHTML = `
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600">${avgAccuracy}%</div>
                <div class="text-sm text-gray-600">Avg Accuracy</div>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600">${totalPredictions.toLocaleString()}</div>
                <div class="text-sm text-gray-600">Total Predictions</div>
            </div>
            <div class="bg-orange-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-orange-600">${totalGraded.toLocaleString()}</div>
                <div class="text-sm text-gray-600">Total Graded</div>
            </div>
            <div class="bg-red-50 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600">${avgErrorRate}%</div>
                <div class="text-sm text-gray-600">Avg Error Rate</div>
            </div>
        `;
    }
</script>
{% endblock %}
