<!-- Processor Failures Component -->
<div class="space-y-6">
    <!-- Retry Queue Section -->
    {% if retry_queue %}
    <div>
        <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-semibold text-gray-700">Failed Processor Retry Queue</h4>
            <div class="flex items-center space-x-3 text-xs">
                {% set pending = retry_queue|selectattr('status', 'equalto', 'pending')|list|length %}
                {% set retrying = retry_queue|selectattr('status', 'equalto', 'retrying')|list|length %}
                {% set exhausted = retry_queue|selectattr('status', 'equalto', 'exhausted')|list|length %}
                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">{{ pending }} pending</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full">{{ retrying }} retrying</span>
                {% if exhausted > 0 %}
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full">{{ exhausted }} exhausted</span>
                {% endif %}
            </div>
        </div>

        <div class="overflow-x-auto max-h-64 overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Processor</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Phase</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Retries</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Next Retry</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Error</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in retry_queue %}
                    <tr class="{% if item.status == 'exhausted' %}bg-red-50{% elif item.status == 'retrying' %}bg-blue-50{% elif item.status == 'pending' %}bg-yellow-50{% endif %}">
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="font-medium text-gray-900">{{ item.processor_name }}</span>
                            {% if item.correlation_id %}
                            <span class="ml-1 text-xs text-gray-400">{{ item.correlation_id[:8] }}</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-center text-gray-600">{{ item.game_date }}</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded">{{ item.phase }}</span>
                        </td>
                        <td class="px-3 py-2 text-center">
                            <span class="{% if item.retry_count >= item.max_retries %}text-red-600 font-bold{% else %}text-gray-600{% endif %}">
                                {{ item.retry_count }}/{{ item.max_retries }}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-center text-xs text-gray-500">
                            {% if item.next_retry_at %}
                            {{ item.next_retry_at[11:16] }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-center">
                            {% if item.status == 'pending' %}
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">Pending</span>
                            {% elif item.status == 'retrying' %}
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Retrying</span>
                            {% elif item.status == 'exhausted' %}
                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Exhausted</span>
                            {% elif item.status == 'resolved' %}
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Resolved</span>
                            {% else %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-xs text-gray-600 max-w-xs truncate" title="{{ item.error_message }}">
                            {{ item.error_message[:80] if item.error_message else '-' }}{% if item.error_message and item.error_message|length > 80 %}...{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <hr class="border-gray-200">
    {% elif retry_queue is defined %}
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
        <div class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 mb-2">
            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <p class="text-sm text-green-700">Retry queue is empty - no processors awaiting retry</p>
    </div>

    <hr class="border-gray-200">
    {% endif %}

    <!-- Recent Failures Section -->
    <div>
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Recent Processor Failures (Last 24 Hours)</h4>

        {% if failures %}
        <div class="space-y-3">
            {% for failure in failures %}
            <div class="border border-red-300 rounded-lg p-4 bg-red-50">
                <div class="flex items-start justify-between mb-2">
                    <div>
                        <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">
                            {{ failure.processor_name }}
                        </span>
                        {% if failure.phase %}
                        <span class="ml-2 px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded">
                            Phase {{ failure.phase }}
                        </span>
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-500">
                        {{ failure.run_id[:8] if failure.run_id else 'N/A' }}
                    </span>
                </div>

                {% if failure.data_date %}
                <div class="text-xs text-gray-600 mb-2">
                    Data Date: {{ failure.data_date }}
                </div>
                {% endif %}

                {% if failure.error_message %}
                <div class="bg-red-100 p-2 rounded text-sm text-red-900 font-mono overflow-x-auto">
                    {{ failure.error_message[:300] }}{% if failure.error_message|length > 300 %}...{% endif %}
                </div>
                {% endif %}

                <div class="mt-2 flex justify-between text-xs text-gray-500">
                    <span>{{ failure.started_at[:19].replace('T', ' ') if failure.started_at else 'N/A' }} ET</span>
                    {% if failure.duration_seconds %}
                    <span>Duration: {{ failure.duration_seconds }}s</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 text-center">
            <p class="text-sm text-red-600 font-medium">
                {{ failures|length }} processor failure(s) in last 24 hours
            </p>
        </div>

        {% else %}
        <div class="text-center py-8">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-100 mb-4">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <p class="text-gray-500">No processor failures in last 24 hours</p>
        </div>
        {% endif %}
    </div>
</div>
