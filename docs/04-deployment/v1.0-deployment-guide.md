# NBA Props Platform v1.0 - Deployment Guide

**Version:** 1.0
**Date:** 2025-11-29
**Status:** Production Ready

---

## Overview

This guide walks you through deploying the complete NBA Props Platform v1.0 event-driven pipeline to Google Cloud Platform.

### What Gets Deployed

1. **Infrastructure**
   - 8 Pub/Sub topics for event-driven orchestration
   - Firestore database for orchestrator state management

2. **Orchestrators** (Cloud Functions - Gen2)
   - Phase 2→3 Orchestrator: Tracks 21 raw processors
   - Phase 3→4 Orchestrator: Tracks 5 analytics processors

3. **Phase 5 Coordinator** (Cloud Run)
   - Prediction coordinator service
   - HTTP endpoints for manual/automated triggers

### Prerequisites

✅ **Required:**
- Google Cloud SDK (`gcloud`) installed and authenticated
- Docker installed (for Phase 5 coordinator)
- Project access to `nba-props-platform`
- Billing enabled on GCP project
- All tests passing (47/47)

✅ **Recommended:**
- Familiarity with GCP Console
- Access to Firestore console for monitoring
- Slack/Email configured for alerts

---

## Quick Start (Automated Deployment)

### Option 1: Deploy Everything at Once

```bash
# From project root
./bin/deploy/deploy_v1_complete.sh
```

This single script:
1. Creates all Pub/Sub topics
2. Verifies Firestore initialization
3. Deploys Phase 2→3 orchestrator
4. Deploys Phase 3→4 orchestrator
5. Deploys Phase 5 coordinator
6. Verifies all deployments
7. Shows next steps

**Estimated Time:** 15-20 minutes

### Option 2: Deploy Step-by-Step

```bash
# 1. Create infrastructure
./bin/pubsub/create_topics.sh

# 2. Deploy Phase 2→3 orchestrator
./bin/orchestrators/deploy_phase2_to_phase3.sh

# 3. Deploy Phase 3→4 orchestrator
./bin/orchestrators/deploy_phase3_to_phase4.sh

# 4. Deploy Phase 5 coordinator
./bin/predictions/deploy/deploy_prediction_coordinator.sh prod

# 5. Verify deployment
./bin/deploy/verify_deployment.sh
```

**Estimated Time:** 20-25 minutes

---

## Step-by-Step Deployment (Manual)

### Step 1: Authenticate and Set Project

```bash
# Login to gcloud
gcloud auth login

# Set active project
gcloud config set project nba-props-platform

# Verify access
gcloud projects describe nba-props-platform
```

### Step 2: Initialize Firestore

**First-time setup only:**

1. Go to [Firebase Console](https://console.firebase.google.com/project/nba-props-platform/firestore)
2. Click "Create Database"
3. Select "Production mode"
4. Choose location: `us-west2` (same as Cloud Functions)
5. Click "Enable"

**Verify:**
```bash
gcloud firestore databases list --project=nba-props-platform
```

### Step 3: Create Pub/Sub Topics

```bash
# Option A: Use script (recommended)
./bin/pubsub/create_topics.sh

# Option B: Create manually
gcloud pubsub topics create nba-phase1-scrapers-complete
gcloud pubsub topics create nba-phase2-raw-complete
gcloud pubsub topics create nba-phase3-trigger
gcloud pubsub topics create nba-phase3-analytics-complete
gcloud pubsub topics create nba-phase4-trigger
gcloud pubsub topics create nba-phase4-processor-complete
gcloud pubsub topics create nba-phase4-precompute-complete
gcloud pubsub topics create nba-phase5-predictions-complete
```

**Verify:**
```bash
gcloud pubsub topics list --project=nba-props-platform
```

You should see 8 topics listed.

### Step 4: Deploy Phase 2→3 Orchestrator

```bash
# Deploy Cloud Function
./bin/orchestrators/deploy_phase2_to_phase3.sh
```

**What this does:**
- Deploys Cloud Function to `us-west2`
- Sets up Pub/Sub trigger on `nba-phase2-raw-complete`
- Configures 256MB memory, 60s timeout
- Max 10 instances for concurrent processing

**Verify:**
```bash
# Check function status
gcloud functions describe phase2-to-phase3-orchestrator \
  --region us-west2 \
  --gen2 \
  --format="value(state)"
# Should output: ACTIVE

# View recent logs
gcloud functions logs read phase2-to-phase3-orchestrator \
  --region us-west2 \
  --limit 20
```

### Step 5: Deploy Phase 3→4 Orchestrator

```bash
# Deploy Cloud Function
./bin/orchestrators/deploy_phase3_to_phase4.sh
```

**What this does:**
- Deploys Cloud Function to `us-west2`
- Sets up Pub/Sub trigger on `nba-phase3-analytics-complete`
- Configures 256MB memory, 60s timeout
- Aggregates entity changes from 5 Phase 3 processors

**Verify:**
```bash
# Check function status
gcloud functions describe phase3-to-phase4-orchestrator \
  --region us-west2 \
  --gen2 \
  --format="value(state)"
# Should output: ACTIVE

# View recent logs
gcloud functions logs read phase3-to-phase4-orchestrator \
  --region us-west2 \
  --limit 20
```

### Step 6: Deploy Phase 5 Prediction Coordinator

```bash
# Deploy to Cloud Run
./bin/predictions/deploy/deploy_prediction_coordinator.sh prod
```

**What this does:**
- Builds Docker image with coordinator code
- Pushes to Artifact Registry
- Deploys to Cloud Run with:
  - 2Gi memory, 2 CPU (production)
  - 600s timeout (10 minutes)
  - Min 1 instance (always warm)
  - Max 1 instance (threading lock compatibility)
- Exposes HTTP endpoints

**Verify:**
```bash
# Get service URL
gcloud run services describe prediction-coordinator \
  --region us-west2 \
  --format="value(status.url)"

# Check service status
gcloud run services describe prediction-coordinator \
  --region us-west2 \
  --format="table(name,status.url,status.latestReadyRevisionName)"

# Test health endpoint
SERVICE_URL=$(gcloud run services describe prediction-coordinator \
  --region us-west2 \
  --format="value(status.url)")
curl $SERVICE_URL/health
```

### Step 7: Verify Complete Deployment

```bash
# Run comprehensive verification
./bin/deploy/verify_deployment.sh
```

This checks:
- ✓ All 8 Pub/Sub topics exist
- ✓ Both orchestrators are ACTIVE
- ✓ Phase 5 coordinator is deployed
- ✓ Firestore is initialized
- ✓ IAM permissions are correct

**Expected output:**
```
========================================
✓ All checks passed!
✓ v1.0 deployment verified
========================================
```

---

## Post-Deployment Configuration

### Set Up Cloud Scheduler (Optional)

For automated daily predictions at 6 AM PT:

```bash
# Get coordinator URL
SERVICE_URL=$(gcloud run services describe prediction-coordinator \
  --region us-west2 \
  --format="value(status.url)")

# Create daily schedule
gcloud scheduler jobs create http daily-predictions \
  --schedule="0 6 * * *" \
  --uri="$SERVICE_URL/start" \
  --http-method=POST \
  --message-body='{"game_date":"today"}' \
  --time-zone="America/Los_Angeles" \
  --location=us-west2
```

### Configure Monitoring Alerts

1. Go to [Cloud Monitoring](https://console.cloud.google.com/monitoring)
2. Create alert policies for:
   - Cloud Function execution errors
   - Cloud Run 5xx errors
   - Pub/Sub dead letter queue messages

---

## Testing the Deployment

### Test 1: Verify Pub/Sub Topics

```bash
# List all topics
gcloud pubsub topics list --project=nba-props-platform | grep nba-phase
```

### Test 2: Test Phase 5 Coordinator Manually

```bash
# Get coordinator URL
SERVICE_URL=$(gcloud run services describe prediction-coordinator \
  --region us-west2 \
  --format="value(status.url)")

# Trigger predictions for a specific date
curl -X POST $SERVICE_URL/start \
  -H "Content-Type: application/json" \
  -d '{"game_date":"2025-11-29"}'

# Check status
curl "$SERVICE_URL/status?game_date=2025-11-29"
```

### Test 3: Monitor Orchestrator Logs

```bash
# Phase 2→3 logs
gcloud functions logs read phase2-to-phase3-orchestrator \
  --region us-west2 \
  --limit 50

# Phase 3→4 logs
gcloud functions logs read phase3-to-phase4-orchestrator \
  --region us-west2 \
  --limit 50
```

### Test 4: Check Firestore State

1. Go to [Firestore Console](https://console.firebase.google.com/project/nba-props-platform/firestore)
2. Look for collections:
   - `phase2_completion/{game_date}` - Phase 2 orchestrator state
   - `phase3_completion/{analysis_date}` - Phase 3 orchestrator state

### Test 5: End-to-End Pipeline Test

**Trigger the complete pipeline:**

1. Manually run a Phase 1 scraper for today's date
2. Watch Phase 2 processors complete (publish to `nba-phase2-raw-complete`)
3. Phase 2→3 orchestrator triggers Phase 3 (publishes to `nba-phase3-trigger`)
4. Phase 3 processors complete (publish to `nba-phase3-analytics-complete`)
5. Phase 3→4 orchestrator triggers Phase 4 (publishes to `nba-phase4-trigger`)
6. Phase 4 processors complete (publish to `nba-phase4-precompute-complete`)
7. Phase 5 coordinator generates predictions

**Verify correlation tracking:**

```bash
# Query run history for a specific date
bq query --use_legacy_sql=false '
SELECT
  phase,
  processor_name,
  correlation_id,
  status,
  processed_at
FROM `nba-props-platform.nba_reference.processor_run_history`
WHERE data_date = "2025-11-29"
ORDER BY processed_at ASC
LIMIT 100
'

# Look for the SAME correlation_id across all phases
# This proves end-to-end traceability!
```

---

## Monitoring and Maintenance

### View Logs

**Cloud Functions:**
```bash
# Phase 2→3
gcloud functions logs read phase2-to-phase3-orchestrator \
  --region us-west2 \
  --limit 100

# Phase 3→4
gcloud functions logs read phase3-to-phase4-orchestrator \
  --region us-west2 \
  --limit 100
```

**Cloud Run:**
```bash
gcloud run services logs read prediction-coordinator \
  --region us-west2 \
  --limit 100
```

### Check Service Status

```bash
# Cloud Functions
gcloud functions list --region us-west2 --filter="name~orchestrator"

# Cloud Run
gcloud run services list --region us-west2 --filter="prediction-coordinator"
```

### Monitor Firestore

- [Firestore Console](https://console.firebase.google.com/project/nba-props-platform/firestore)
- Check document counts in collections
- Monitor for stale orchestrator state (documents > 7 days old)

### Cost Monitoring

```bash
# View current month's costs
gcloud billing accounts list
# Then visit: https://console.cloud.google.com/billing
```

---

## Troubleshooting

### Issue: Orchestrator Not Triggering

**Symptoms:**
- Phase 2 completes but Phase 3 doesn't start
- No logs in Phase 2→3 orchestrator

**Solutions:**
1. Check Pub/Sub subscription exists:
   ```bash
   gcloud pubsub subscriptions list | grep phase2
   ```

2. Check Cloud Function trigger:
   ```bash
   gcloud functions describe phase2-to-phase3-orchestrator \
     --region us-west2 \
     --gen2 \
     --format="value(eventTrigger.trigger)"
   ```

3. Manually publish test message:
   ```bash
   gcloud pubsub topics publish nba-phase2-raw-complete \
     --message='{"processor_name":"test","game_date":"2025-11-29","status":"success"}'
   ```

### Issue: Cloud Function Timeout

**Symptoms:**
- Function logs show "Function execution took X ms, finished with status: timeout"

**Solutions:**
1. Increase timeout:
   ```bash
   gcloud functions deploy phase2-to-phase3-orchestrator \
     --region us-west2 \
     --gen2 \
     --timeout=120s
   ```

2. Optimize Firestore queries (use indexes)

### Issue: Phase 5 Coordinator Not Responding

**Symptoms:**
- HTTP requests to coordinator timeout
- 503 errors

**Solutions:**
1. Check service status:
   ```bash
   gcloud run services describe prediction-coordinator \
     --region us-west2
   ```

2. Check logs for errors:
   ```bash
   gcloud run services logs read prediction-coordinator \
     --region us-west2 \
     --limit 100
   ```

3. Increase memory/CPU if needed:
   ```bash
   gcloud run services update prediction-coordinator \
     --region us-west2 \
     --memory 4Gi \
     --cpu 2
   ```

### Issue: Firestore Permission Denied

**Symptoms:**
- Cloud Functions log: "Permission denied on Firestore"

**Solutions:**
1. Check service account has Firestore permissions:
   ```bash
   gcloud projects get-iam-policy nba-props-platform \
     --flatten="bindings[].members" \
     --filter="bindings.members:*@appspot.gserviceaccount.com"
   ```

2. Add Firestore permissions:
   ```bash
   gcloud projects add-iam-policy-binding nba-props-platform \
     --member="serviceAccount:PROJECT_NUMBER@appspot.gserviceaccount.com" \
     --role="roles/datastore.user"
   ```

---

## Rollback Procedures

### Rollback Cloud Function

```bash
# List revisions
gcloud functions list --region us-west2

# Deploy previous version (if you have the source)
cd orchestration/cloud_functions/phase2_to_phase3
gcloud functions deploy phase2-to-phase3-orchestrator \
  --region us-west2 \
  --gen2 \
  --source=. \
  --entry-point=orchestrate_phase2_to_phase3
```

### Rollback Cloud Run

```bash
# List revisions
gcloud run revisions list \
  --region us-west2 \
  --service prediction-coordinator

# Rollback to specific revision
gcloud run services update-traffic prediction-coordinator \
  --region us-west2 \
  --to-revisions=prediction-coordinator-00001-abc=100
```

---

## Next Steps

After successful deployment:

1. **Set up monitoring dashboards**
   - Cloud Monitoring for metrics
   - Log-based alerts for errors

2. **Configure alerting**
   - Email alerts for critical failures
   - Slack integration for warnings

3. **Run backfill (optional)**
   - Load historical data if needed
   - See: `docs/backfill/backfill-guide.md`

4. **Enable daily processing**
   - Set up Cloud Scheduler
   - Monitor overnight runs

5. **Performance tuning**
   - Adjust instance counts based on load
   - Optimize queries for efficiency

---

## Useful Commands Reference

```bash
# === DEPLOYMENT ===
# Full deployment
./bin/deploy/deploy_v1_complete.sh

# Verify deployment
./bin/deploy/verify_deployment.sh

# === LOGS ===
# View orchestrator logs
gcloud functions logs read phase2-to-phase3-orchestrator --region us-west2 --limit 50
gcloud functions logs read phase3-to-phase4-orchestrator --region us-west2 --limit 50

# View coordinator logs
gcloud run services logs read prediction-coordinator --region us-west2 --limit 50

# === STATUS ===
# Check function status
gcloud functions list --region us-west2

# Check service status
gcloud run services list --region us-west2

# Check topics
gcloud pubsub topics list

# === TESTING ===
# Test coordinator
SERVICE_URL=$(gcloud run services describe prediction-coordinator --region us-west2 --format="value(status.url)")
curl -X POST $SERVICE_URL/start -H "Content-Type: application/json" -d '{"game_date":"2025-11-29"}'

# === MONITORING ===
# Firestore console
https://console.firebase.google.com/project/nba-props-platform/firestore

# Cloud Monitoring
https://console.cloud.google.com/monitoring

# Cloud Functions console
https://console.cloud.google.com/functions
```

---

## Support and Documentation

- **Architecture Overview:** `docs/01-architecture/event-driven-pipeline.md`
- **Orchestrator Design:** `docs/08-projects/current/phase4-phase5-integration/`
- **Troubleshooting Guide:** `docs/troubleshooting/common-issues.md`
- **Change Detection Guide:** `docs/features/change-detection.md`

---

**Document Version:** 1.0
**Last Updated:** 2025-11-29
**Maintained By:** Engineering Team
