# v1.1 Real-Time Architecture & Migration Framework

**Supplement to:** UNIFIED-ARCHITECTURE-DESIGN.md
**Purpose:** Document future real-time architecture and when to migrate
**Status:** Planning Document (for future implementation)

---

## 9. v1.1 Real-Time Architecture (Future)

### 9.1 When v1.0 Becomes Insufficient

**v1.0 (Batch + Change Detection) works well for:**
- ‚úÖ Daily batch processing (overnight games)
- ‚úÖ Mid-day updates (injury reports every 2-4 hours)
- ‚úÖ Response time: 2-5 minutes acceptable

**v1.1 (True Real-Time) needed when:**
- ‚ùå Sub-minute latency required (injury ‚Üí prediction in < 60 seconds)
- ‚ùå Event-driven triggers (manual injury entry, lineup announcements)
- ‚ùå Betting line movements trigger prediction updates
- ‚ùå User-facing real-time features (live prediction updates on website)

**Key Difference:**
- v1.0: Wait for scraper to run (batch) ‚Üí detect changes ‚Üí process
- v1.1: Event triggers processing immediately (single player only)

---

### 9.2 v1.1 Architecture: Dual-Path System

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TWO PARALLEL PATHS                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  PATH 1: Daily Batch (Existing v1.0)                            ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                       ‚îÇ
‚îÇ  11:00 PM - Scrapers run (all players)                          ‚îÇ
‚îÇ    ‚Üì                                                             ‚îÇ
‚îÇ  Phase 2 ‚Üí Phase 3 ‚Üí Phase 4 ‚Üí Phase 5                          ‚îÇ
‚îÇ    ‚Üì                                                             ‚îÇ
‚îÇ  With change detection (only process changed entities)          ‚îÇ
‚îÇ    ‚Üì                                                             ‚îÇ
‚îÇ  6:00 AM - All predictions ready                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  PATH 2: Real-Time Incremental (NEW in v1.1)                    ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                      ‚îÇ
‚îÇ  2:00 PM - Event trigger (injury report manually entered)       ‚îÇ
‚îÇ    ‚Üì                                                             ‚îÇ
‚îÇ  Webhook/API call with player ID + change type                  ‚îÇ
‚îÇ    ‚Üì                                                             ‚îÇ
‚îÇ  Incremental Phase 2 (/process-player endpoint)                 ‚îÇ
‚îÇ    ‚Üì Process ONE player only                                    ‚îÇ
‚îÇ  Incremental Phase 3 (/process-player endpoint)                 ‚îÇ
‚îÇ    ‚Üì Recalculate analytics for ONE player                       ‚îÇ
‚îÇ  Incremental Phase 4 (/process-player endpoint)                 ‚îÇ
‚îÇ    ‚Üì Regenerate features for ONE player                         ‚îÇ
‚îÇ  Incremental Phase 5 (/predict-player endpoint)                 ‚îÇ
‚îÇ    ‚Üì Generate predictions for ONE player                        ‚îÇ
‚îÇ  2:01 PM - Updated prediction ready (1 minute!)                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Predictions marked with version/supersedes old predictions     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 9.3 v1.1 Message Format: Incremental Flag

```python
{
    # ... all existing unified fields ...

    # v1.1 NEW: Incremental processing flag
    "is_incremental": true,              # Signals incremental mode

    # v1.1 NEW: Single entity targeting
    "target_entity_id": "lebron-james",  # Specific player/team
    "target_entity_type": "player",      # player | team

    # v1.1 NEW: Change event details
    "change_event": {
        "event_type": "injury_status_change",
        "trigger_source": "manual_entry",  # manual_entry | webhook | api
        "trigger_user": "ops@example.com",
        "old_value": "PROBABLE",
        "new_value": "OUT",
        "change_timestamp": "2025-11-28T14:00:00Z"
    },

    # v1.1 NEW: Versioning for superseding
    "prediction_version": 2,
    "supersedes_version": 1,
    "supersedes_batch_id": "batch_2025-11-28_06:00"
}
```

---

### 9.4 v1.1 New Endpoints (Per-Player Processing)

**Phase 2: /process-player**
```python
@app.route('/process-player', methods=['POST'])
def process_single_player():
    """
    Process raw data for a single player (incremental update).

    Request:
    {
        "player_lookup": "lebron-james",
        "game_date": "2025-11-28",
        "change_type": "injury_status",
        "correlation_id": "manual-trigger-123"
    }
    """
    # Load ONLY this player's raw data
    # Process ONLY this player
    # MERGE upsert for one player
    # Publish incremental event to Phase 3
```

**Phase 3: /process-player**
```python
@app.route('/process-player', methods=['POST'])
def process_single_player_analytics():
    """
    Recalculate analytics for a single player.
    """
    # Query ONLY this player's raw data
    # Calculate analytics for ONE player
    # MERGE upsert
    # Publish incremental event to Phase 4
```

**Phase 4: /process-player**
```python
@app.route('/process-player', methods=['POST'])
def process_single_player_features():
    """
    Regenerate ML features for a single player.
    """
    # Recalculate precompute metrics for ONE player
    # Update ml_feature_store_v2 for ONE player
    # Publish incremental event to Phase 5
```

**Phase 5: /predict-player**
```python
@app.route('/predict-player', methods=['POST'])
def predict_single_player():
    """
    Generate predictions for a single player (supersedes old).
    """
    # Run 5 prediction systems for ONE player
    # Insert with new version number
    # Mark old predictions as superseded
    # Publish completion event
```

---

### 9.5 v1.1 Trigger Sources

**Manual Triggers:**
```
Ops Dashboard ‚Üí Injury Status Changed
  ‚Üì API POST to /trigger-player-update
  ‚Üì Publishes to: nba-player-update-trigger
  ‚Üì Incremental pipeline starts
```

**Webhook Triggers:**
```
Data Provider ‚Üí Injury Report Webhook
  ‚Üì POST to /webhook/injury-update
  ‚Üì Validates + publishes to: nba-player-update-trigger
  ‚Üì Incremental pipeline starts
```

**Line Movement Triggers:**
```
Odds API ‚Üí Detects line move > 2 points
  ‚Üì POST to /webhook/line-movement
  ‚Üì Publishes to: nba-player-update-trigger
  ‚Üì Incremental pipeline regenerates predictions
```

---

### 9.6 v1.1 Prediction Versioning

**Problem:** How to handle updated predictions?

**Solution:** Version-based superseding

```sql
-- Schema update for v1.1
ALTER TABLE player_prop_predictions ADD COLUMN (
    prediction_version INT64,        -- 1, 2, 3, ... increments
    superseded_by STRING,             -- prediction_id that replaced this
    is_superseded BOOLEAN,            -- true if newer version exists
    superseded_at TIMESTAMP,          -- when it was replaced
    batch_id STRING,                  -- which batch created this
    is_realtime_update BOOLEAN        -- true if from incremental path
);

-- Query for latest prediction (v1.1)
SELECT *
FROM player_prop_predictions
WHERE player_lookup = 'lebron-james'
  AND game_date = '2025-11-28'
  AND is_superseded = FALSE
ORDER BY prediction_version DESC
LIMIT 1
```

**Update flow:**
```python
# When creating new incremental prediction
def create_incremental_prediction(player, new_prediction):
    # 1. Find existing predictions for this player/date
    existing = get_latest_prediction(player, game_date)

    # 2. Mark old as superseded
    if existing:
        mark_as_superseded(
            prediction_id=existing.prediction_id,
            superseded_by=new_prediction_id
        )

    # 3. Insert new prediction with version = existing.version + 1
    insert_prediction(
        player=player,
        game_date=game_date,
        prediction_version=existing.version + 1 if existing else 1,
        is_realtime_update=True,
        ...
    )
```

---

### 9.7 v1.1 Cost & Performance

**Cost Analysis:**

| Scenario | v1.0 (Batch + Change Detection) | v1.1 (Incremental) |
|----------|--------------------------------|-------------------|
| **Daily batch** | 1 run √ó 5 phases = 5 runs | Same |
| **1 injury update/day** | 5 change detection queries | 5 incremental processing calls |
| **10 injury updates/day** | 50 change detection queries | 50 incremental processing calls |
| **Per-update cost** | ~$0.01 (queries) | ~$0.05 (Cloud Run) |
| **Monthly cost (10 updates/day)** | ~$3 | ~$15 |

**Performance:**

| Metric | v1.0 | v1.1 |
|--------|------|------|
| Latency (1 player update) | 2-5 minutes | 30-60 seconds |
| Concurrent updates | Sequential (batch) | Parallel (per-player) |
| User experience | Good | Excellent |

---

## 10. Migration Decision Framework

### 10.1 When to Migrate from v1.0 to v1.1

**Quantitative Triggers:**

| Metric | Threshold | Action |
|--------|-----------|--------|
| **Daily incremental updates** | > 20/day | Consider v1.1 |
| **User requests for real-time** | > 10/week | Consider v1.1 |
| **Line movement triggers needed** | Yes | Implement v1.1 |
| **Sub-minute latency required** | Yes | Implement v1.1 |
| **Acceptable monthly cost increase** | > $50/month | Proceed with v1.1 |

**Qualitative Triggers:**
- ‚úÖ Users actively using predictions during games (not just pre-game)
- ‚úÖ Competitor has real-time prediction updates
- ‚úÖ Business model depends on intra-game updates
- ‚úÖ Manual injury entry system exists (ops dashboard)

---

### 10.2 Migration Strategy (v1.0 ‚Üí v1.1)

**Phase 1: Build Incremental Infrastructure (Week 1-2)**
1. Add /process-player endpoints to Phases 2-5
2. Create nba-player-update-trigger Pub/Sub topic
3. Add prediction versioning to schema
4. Write comprehensive tests

**Phase 2: Deploy Parallel Path (Week 3)**
1. Deploy new endpoints (alongside existing batch)
2. Create manual trigger API/dashboard
3. Test with staging data
4. Monitor costs and performance

**Phase 3: Gradual Rollout (Week 4+)**
1. Enable for small subset of players (e.g., stars only)
2. Monitor latency and costs
3. Expand to all players gradually
4. Keep v1.0 batch as primary (v1.1 is supplementary)

**Phase 4: Optimization (Month 2)**
1. Add webhook integrations (data providers)
2. Add line movement triggers
3. Optimize per-player processing
4. Build real-time monitoring dashboards

---

### 10.3 Hybrid Operation (v1.0 + v1.1 Together)

**Recommended approach:** Run BOTH paths indefinitely

```
Daily Batch (v1.0):
- Primary source of truth
- Runs overnight
- Processes all players
- Full recalculation
- Foundation for the day

Incremental Updates (v1.1):
- Supplementary updates
- Event-driven (injuries, lineups)
- Single-player processing
- Supersedes batch predictions
- Responsive to changes
```

**Benefits of hybrid:**
- ‚úÖ Batch ensures complete daily coverage
- ‚úÖ Incremental provides real-time responsiveness
- ‚úÖ Batch catches anything incremental missed
- ‚úÖ Incremental keeps predictions current throughout day
- ‚úÖ Either path can fail without total system failure

---

### 10.4 Go/No-Go Checklist for v1.1

**Before implementing v1.1, confirm:**

- [ ] v1.0 has run in production for >= 1 month
- [ ] v1.0 batch processing is stable (>98% success rate)
- [ ] Change detection is working correctly
- [ ] Business case exists (user demand or revenue opportunity)
- [ ] Cost increase is acceptable ($15-50/month)
- [ ] Engineering resources available (3-4 weeks)
- [ ] Ops team ready for real-time monitoring
- [ ] Prediction versioning strategy approved
- [ ] Rollback plan documented

**If all checkboxes = ‚úÖ ‚Üí Proceed with v1.1**
**If any = ‚ùå ‚Üí Stay on v1.0, revisit in 3 months**

---

### 10.5 Long-Term Vision (v2.0+)

**v2.0: Multi-Prop Support**
- Expand beyond points to rebounds, assists, threes
- Same architecture (batch + incremental)
- Per-prop versioning

**v3.0: Multi-Sport Support**
- NHL, NFL, MLB using same pipeline patterns
- Shared infrastructure, sport-specific processors

**v4.0: User-Triggered Predictions**
- Users can request custom predictions
- "What if Curry plays 35 minutes instead of 30?"
- On-demand processing for premium users

---

## Summary: v1.0 vs v1.1 Decision Matrix

| Aspect | v1.0 (Batch + Change Detection) | v1.1 (Incremental Real-Time) |
|--------|--------------------------------|------------------------------|
| **Best for** | Daily batch processing, mid-day updates | Real-time event response |
| **Latency** | 2-5 minutes | 30-60 seconds |
| **Cost** | ~$20/month | ~$35-50/month |
| **Complexity** | Medium | High |
| **User experience** | Good | Excellent |
| **When to use** | MVP, early product | Mature product, user demand |
| **Implementation time** | 3-4 weeks | Additional 3-4 weeks |

**Recommendation:**
- ‚úÖ **Start with v1.0** - Get the basics right
- ‚è≥ **Monitor for 1-2 months** - Gather real usage data
- üìä **Decide based on metrics** - Let data drive the decision
- üöÄ **Add v1.1 when justified** - Clear business case + stable v1.0

---

**Document Status:** ‚úÖ Complete Planning Guide
**Next Action:** Implement v1.0, monitor, then revisit v1.1 decision in 2-3 months
