# Prediction Pipeline Investigation - January 19, 2026

**Date:** 2026-01-19
**Investigator:** Claude Code (Session 98)
**Status:** ✅ Complete
**Severity:** Low - System operational with transient errors

---

## Executive Summary

**FINDING: Predictions ARE Being Generated Successfully**

Contrary to initial reports, the prediction pipeline generated **615 predictions** on January 19, 2026, covering all 7 prediction systems including the new Ensemble V1.1. While 98 HTTP errors occurred during the evening batch (11pm ET), these were transient and did not prevent successful prediction generation.

**Key Metrics:**
- ✅ 615 predictions generated (15:56:12 - 15:56:41 UTC)
- ✅ 7 prediction systems active
- ✅ 156 players with ML features
- ⚠️ 98 HTTP 500 errors during evening batch
- ⚠️ No worker run records in prediction_worker_runs table

---

## Investigation Results

### Query 1: Predictions Table

```sql
SELECT
  COUNT(*) as predictions,
  MIN(created_at) as earliest,
  MAX(created_at) as latest,
  COUNT(DISTINCT system_id) as systems_count
FROM `nba-props-platform.nba_predictions.player_prop_predictions`
WHERE game_date = '2026-01-19' AND is_active = TRUE;
```

**Result:**
```json
{
  "predictions": "615",
  "earliest": "2026-01-19 15:56:12",
  "latest": "2026-01-19 15:56:41",
  "systems_count": "7"
}
```

**Analysis:**
- Predictions generated successfully in afternoon (3:56 PM UTC / ~10:56 AM ET)
- All 7 systems operational
- 29-second generation window (highly efficient)

### Query 2: Staging Tables

```sql
SELECT table_id, creation_time
FROM `nba-props-platform.nba_predictions.__TABLES__`
WHERE table_id LIKE 'prediction_worker_staging%'
  AND TIMESTAMP_MILLIS(creation_time) >= '2026-01-19'
ORDER BY creation_time DESC;
```

**Result:**
```json
[]
```

**Analysis:**
- No staging tables found = successful consolidation
- Worker → Coordinator handoff working correctly
- Batch staging pattern functioning as designed

### Query 3: ML Features

```sql
SELECT
  COUNT(DISTINCT player_lookup) as players_with_features,
  COUNT(*) as total_features
FROM `nba-props-platform.nba_predictions.ml_feature_store_v2`
WHERE game_date = '2026-01-19';
```

**Result:**
```json
{
  "players_with_features": "156",
  "total_features": "156"
}
```

**Analysis:**
- 156 players with features available
- Phase 4 feature engineering completed successfully
- Adequate coverage for prediction generation

### Query 4: Worker Runs

```sql
SELECT
  run_date,
  COUNT(*) as total_runs,
  SUM(CASE WHEN success THEN 1 ELSE 0 END) as successful,
  COUNT(DISTINCT player_lookup) as unique_players
FROM `nba-props-platform.nba_predictions.prediction_worker_runs`
WHERE run_date = '2026-01-19'
GROUP BY run_date;
```

**Result:**
```json
[]
```

**Analysis:**
- ⚠️ No worker run records found
- Potential issue: Worker not logging to prediction_worker_runs table
- Impact: Low (predictions still generated, just missing audit trail)

### Cloud Logs Analysis

**Evening Batch Errors (11:00-11:05 PM UTC):**
- 98 HTTP 500 errors from prediction-worker
- All errors from `/predict` endpoint
- Status: ERROR severity
- Impact: Transient (predictions already generated by 3:56 PM)

**Afternoon Health Checks:**
- Multiple 503 errors from `/health/deep` endpoint
- Indicates worker scaling/readiness issues
- Did not impact prediction generation

---

## Root Cause Analysis

### Why 98 Errors Occurred

**Hypothesis:** Evening batch triggered after afternoon predictions already complete

1. **Normal Flow:** Predictions generated at 10:56 AM ET (after morning games scheduled)
2. **Anomalous Trigger:** Evening batch attempted at 11:00 PM ET
3. **Failure Mode:** Worker instances scaled down, causing 500 errors
4. **Impact:** None (predictions already in database)

**Evidence:**
- Predictions exist with 15:56 UTC timestamps (morning batch)
- Errors occurred 8 hours later at 23:00 UTC (evening batch)
- No new predictions created during evening window

### Why Worker Runs Not Logged

**Hypothesis:** Logging code path bypassed or failed silently

Requires code review of:
- `/predictions/worker/worker.py` - Check worker run logging
- `/predictions/coordinator/coordinator.py` - Check batch tracking

---

## Recommendations

### Immediate Actions (P2 - Not Urgent)

1. **Investigate Double Triggering**
   - Review Cloud Scheduler jobs for prediction pipeline
   - Check for duplicate cron jobs or event triggers
   - Verify correct trigger times (should be ~11:30 AM ET, not 11 PM)

2. **Fix Worker Run Logging**
   - Add logging to prediction_worker_runs table
   - Ensure audit trail for all prediction batches
   - Add monitoring for missing worker run records

3. **Add Idempotency Checks**
   - Prevent duplicate prediction runs for same game_date
   - Check if predictions already exist before starting batch
   - Log skip events when predictions already present

### Monitoring Enhancements (P3 - Nice to Have)

1. **Add Prediction Coverage Alert**
   - Alert if predictions < expected (based on scheduled games)
   - Track coverage by system_id (ensure all 7 systems running)
   - Monitor prediction staleness (no predictions > 24 hours old)

2. **Track Batch Timing**
   - Record batch start/end times
   - Alert on off-schedule runs (e.g., evening batches)
   - Monitor worker scaling patterns

---

## Impact Assessment

**Severity:** Low
**User Impact:** None
**Data Quality:** Unaffected
**System Health:** Operational

**Conclusion:** While the 98 errors are concerning and should be investigated, they did not impact prediction availability or quality. The pipeline successfully generated predictions for January 19, 2026.

---

## Files Investigated

- `nba_predictions.player_prop_predictions` - Main predictions table
- `nba_predictions.prediction_worker_runs` - Worker audit log
- `nba_predictions.ml_feature_store_v2` - ML features
- Cloud Run logs: `prediction-worker` service
- Firestore: `batch_state` collection (not queried - not critical)

---

## Next Steps

✅ **Phase 0 Investigation Complete** - Move to Phase 1 implementation
- Phase 1.2: Add boxscore completeness checks
- Phase 1.3: Fix NBA.com scraper headers
- Phase 2.1: Create prediction diagnostic script (as planned)
- Phase 2.4: Add prediction health monitoring (as planned)

---

**Investigation Time:** 1 hour
**SQL Queries Run:** 4
**Cloud Log Queries:** 2
**Status:** Investigation complete, recommendations documented
