# Session 168 Handoff: Backfill, Bug Fixes, Model UNDER Bias Crisis

**Date:** 2026-02-09
**Focus:** Backfill completion, three bug fixes deployed, model performance deep dive, stale model audit
**Commit:** `ea75d1c7` — pushed to main, Cloud Build deployed coordinator + worker at 08:22 UTC

## Summary

Completed the Feb 5-7 backfill from Session 167, discovered and fixed three bugs (supersede, vegas null-out, PRE_GAME mode mapping), conducted a comprehensive investigation into the model's performance dip from Jan 26 onward, and discovered additional critical issues: stale model predictions polluting the database, the broken `catboost_v9_2026_02` still config-enabled, and **the model's UNDER bias is worsening** (-3.84 avg_pvl on today's predictions despite all fixes being deployed).

## URGENT: Model UNDER Bias Getting Worse

**Today (Feb 9), after all bug fixes deployed, catboost_v9 predictions show avg_pvl = -3.84.**

This is NOT the vegas null-out bug — today's predictions have real Vegas lines (Zion 25.5, Bam 23.5, Randle 23.5). The model genuinely predicts 4-10 points below the lines for star players. This is the same UNDER bias from the investigation, accelerating:

| Week | Avg Pred vs Vegas | % OVER Recs |
|------|-------------------|-------------|
| Jan 12 | +1.29 | 54.9% |
| Jan 19 | -0.07 | 50.9% |
| Jan 26 | -0.26 | 39.1% |
| Feb 2 | -0.94 | 15.1% |
| **Feb 9** | **-3.84** | **~0%** |

The model is completely broken for UNDER. Every prediction is an UNDER recommendation. This needs immediate attention.

## What Was Done

### 1. Backfill Feb 5-7 Predictions

| Date | Active Predictions | Model | avg_pvl |
|------|-------------------|-------|---------|
| Feb 5 | 104 | v9_20260201_011018 (correct) | -0.11 |
| Feb 6 | 72 | v9_20260201_011018 (correct) | -0.17 |
| Feb 7 | 137 | v9_20260201_011018 (correct) | -0.03 |

### 2. Three Bug Fixes (Committed + Deployed)

| Bug | File | Fix |
|-----|------|-----|
| Supersede doesn't deactivate | `coordinator.py:2034-2041,2094-2102` | Added `is_active = FALSE` to both supersede functions |
| Worker nulls out vegas features | `worker.py:1095-1113` | New `elif` preserves feature store vegas values when coordinator has no line |
| PRE_GAME not in mode map | `quality_gate.py:666` | Added explicit `'PRE_GAME': PredictionMode.FIRST` mapping |

### 3. Re-graded Feb 2-7, Re-materialized Subsets

All 6 dates graded via Pub/Sub, subsets exported to GCS.

### 4. Fixed Feb 4 Bad Predictions

Deactivated 99 PRE_GAME predictions (null vegas, -3.44 avg_pvl) via BQ UPDATE. **However:** The 17 re-activated BACKFILL predictions use wrong model `v9_36features_20260108_212239` — see Open Issues below.

### 5. Experiment: Retraining on Same Dates

GATES FAILED. Head-to-head on 276 overlapping players: both 48.9% hit rate. No benefit from retraining.

## CRITICAL: Stale Model Predictions in Database

**11 different model/version combos have active predictions for Feb 2+:**

| system_id | model_version | Active | Status | Last Generated |
|-----------|--------------|--------|--------|---------------|
| **catboost_v9** | **v9_20260201_011018** | **356** | **PRODUCTION (correct)** | **Feb 9** |
| catboost_v9 | v9_current_season | 269 | **STALE — wrong model era** | Feb 8 |
| catboost_v9 | v9_36features_20260108_212239 | 17 | **WRONG MODEL — Feb 4 only** | Feb 8 |
| catboost_v9_2026_02 | catboost_v9_2026_02 | 823 | **BROKEN — Session 163 UNDER bias** | Feb 8 |
| catboost_v8 | catboost_v8 | 858 | Legacy model, still running | Feb 9 |
| ensemble_v1 | ensemble_v1 | 865 | Non-catboost system | Feb 9 |
| ensemble_v1_1 | ensemble_v1_1 | 865 | Non-catboost system | Feb 9 |
| moving_average | v1 | 865 | Non-catboost system | Feb 9 |
| similarity_balanced_v1 | v1 | 621 | Non-catboost system | Feb 9 |
| zone_matchup_v1 | v1 | 865 | Non-catboost system | Feb 9 |

**Subsets only use `system_id = 'catboost_v9'`** — so the other models don't affect subset picks. But:
- `v9_current_season` (269) and `v9_36features` (17) ARE under `system_id = 'catboost_v9'` and DO pollute subset calculations
- `catboost_v9_2026_02` (823) pollutes the `prediction_accuracy` grading table

### Root Cause: How Stale Models Got There

1. **`v9_current_season`** — Generated before Session 167's model loading fix. The worker was loading the wrong local model file.
2. **`v9_36features_20260108_212239`** — Generated by Session 167's backfill runs that happened before the env var fix was deployed. The 17 Feb 4 predictions we "rescued" are actually from this wrong model.
3. **`catboost_v9_2026_02`** — The broken Feb 2 retrain model. Lives in `catboost_monthly.py` line 55 with `"enabled": True`. Session 167 deleted the local file, so it stopped generating after Feb 8, but **the config still says enabled**.

## Production Deployment State

**Worker env vars (confirmed):**
- `CATBOOST_V9_MODEL_PATH=gs://nba-props-platform-models/catboost/v9/catboost_v9_33features_20260201_011018.cbm`
- `BUILD_COMMIT=ea75d1c7` (Session 168 fixes)

**Coordinator:** `BUILD_COMMIT=ea75d1c` (Session 168 fixes)

## Investigation Findings

### Production Model Performance (Jan 9 - Feb 7)

| Filter | Bets | Hit Rate | ROI |
|--------|------|----------|-----|
| High Quality (5+ edge) | 174 | **74.7%** | +42.7% |
| Medium Quality (3+ edge) | 495 | **62.2%** | +18.8% |
| All Picks (excl PASS) | 1,913 | **53.8%** | +2.7% |

### Root Causes of the Dip

1. **Systematic UNDER bias** — OVER recs dropped from 55% → 15%. Model predicts increasingly below Vegas lines.
2. **Pre-ASB scoring bump** — +0.33 to +0.55 PPG above rolling averages, confirmed across 4 seasons. But last season's V8 model handled this fine.
3. **Trade deadline disruption (Feb 5)** — Trade teams dropped to 47.2% hit rate.
4. **Vegas getting sharper** — Model MAE gap vs Vegas went from -0.23 (winning) to +0.54 (losing).
5. **Feb 4 PRE_GAME bug** — Null vegas lines caused -3.44 avg_pvl (now fixed).

### PRE_GAME Bug: Full Trace

```
Cloud Scheduler fires at 23:00 UTC targeting tomorrow's games
  → Coordinator queries odds_api WHERE game_date = tomorrow
  → Returns NOTHING (props not posted until ~07:00 UTC game day)
  → actual_prop_line = None in Pub/Sub message
  → Worker else branch NULLS OUT feature store vegas data
  → Model predicts blind → -3.44 avg_pvl
```

### Subset Performance (Jan 9 - Feb 7)

| Subset | Picks | Hit Rate | ROI |
|--------|-------|----------|-----|
| Green Light | 109 | **84.4%** | +61.1% |
| High Edge OVER | 101 | **81.2%** | +55.0% |
| Ultra High Edge | 75 | **78.7%** | +50.2% |
| High Edge All | 177 | **74.6%** | +42.4% |
| All Picks | 505 | **61.8%** | +17.9% |

### Model Version Naming

**Convention from Session 165:** `catboost_v9_33f_train{start}-{end}_{timestamp}.cbm`

The `model_version` column in predictions is derived from the filename by `_derive_model_version()` in `catboost_v9.py:55-68`. It strips the prefix to get something like `v9_20260201_011018`. The training date range is NOT currently in the model_version column — only the creation timestamp.

### How Subsets Select Predictions

- All 8 subsets are `system_id = 'catboost_v9'` (confirmed in `dynamic_subset_definitions`)
- They filter by edge, direction, signal condition, and top N ranking
- They do NOT filter by `model_version` — so any `catboost_v9` prediction (including stale `v9_current_season`) can leak into subsets

## Open Issues for Next Session (Priority Order)

### P0: Model UNDER Bias Crisis
- Today's avg_pvl is -3.84, accelerating from -0.94 last week
- The model is NOT usable for new picks until this is addressed
- Options: (a) pause predictions, (b) apply a bias correction offset, (c) retrain with recent data, (d) investigate if feature store data has shifted

### P1: Stale Model Cleanup
Deactivate these via BQ UPDATE:
```sql
-- Deactivate v9_current_season (wrong model era)
UPDATE nba_predictions.player_prop_predictions
SET is_active = FALSE, superseded = TRUE, superseded_reason = 'Session 168: stale model cleanup'
WHERE system_id = 'catboost_v9' AND model_version = 'v9_current_season' AND is_active = TRUE;

-- Deactivate v9_36features (wrong model, Feb 4 only)
UPDATE nba_predictions.player_prop_predictions
SET is_active = FALSE, superseded = TRUE, superseded_reason = 'Session 168: wrong model file'
WHERE system_id = 'catboost_v9' AND model_version = 'v9_36features_20260108_212239' AND is_active = TRUE;

-- Deactivate catboost_v9_2026_02 (broken Feb 2 retrain)
UPDATE nba_predictions.player_prop_predictions
SET is_active = FALSE, superseded = TRUE, superseded_reason = 'Session 168: broken model deactivation'
WHERE system_id = 'catboost_v9_2026_02' AND is_active = TRUE;
```

### P2: Disable Broken Monthly Model Config
In `predictions/worker/prediction_systems/catboost_monthly.py` line 55:
Change `"enabled": True` → `"enabled": False` for `catboost_v9_2026_02`.

### P3: Re-backfill Feb 4
After stale cleanup, Feb 4 will have 0 active catboost_v9 predictions (the 17 we rescued were from the wrong model). Need a fresh BACKFILL.

### P4: Subset Leak Prevention
Subsets should filter by `model_version` not just `system_id` to prevent stale model predictions from leaking in.

### P5: Add avg_pvl Monitoring
Alert when a batch's avg_pvl < -2.0. Would have caught Feb 4 immediately.

## Files Modified This Session

| File | Change |
|------|--------|
| `predictions/coordinator/coordinator.py` | Supersede bug fix: `is_active = FALSE` |
| `predictions/worker/worker.py` | Vegas null-out fix: preserve feature store values |
| `predictions/coordinator/quality_gate.py` | PRE_GAME mode mapping |
| `docs/09-handoff/2026-02-09-SESSION-168-HANDOFF.md` | This document |
