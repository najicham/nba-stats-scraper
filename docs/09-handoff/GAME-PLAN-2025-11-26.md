# Game Plan - Data Coverage & Backfills
**Date:** 2025-11-26 Evening
**Status:** Active
**Session Goal:** Complete critical backfills with proper gap tracking

---

## Executive Summary

We successfully completed team boxscore backfill (99.9%) and discovered 6 Play-In games with no data from any source. Rather than skip documentation, we implemented a lightweight gap tracking system to ensure nothing gets lost as we move forward.

**Key Achievement:** Applied source coverage design principles to a real-world gap BEFORE implementing the full system.

---

## What We Just Completed ‚úÖ

1. **Team Boxscore Backfill**
   - Status: 5,293 of 5,299 games (99.9%)
   - Time: ~6.5 hours overnight
   - Blockers: 6 Play-In Tournament games (all sources failed)

2. **Gap Documentation System**
   - Created: `docs/09-handoff/known-data-gaps.md`
   - Created: `docs/09-handoff/data-coverage-tracker.md`
   - Updated: Backfill handoff doc with status
   - Result: Complete audit trail of what we're moving past

3. **Source Coverage Analysis**
   - Applied fallback cascade pattern to 6 games
   - Tested: NBA.com ‚Üí ESPN ‚Üí BDL ‚Üí Reconstruction
   - Result: All sources failed (documented)
   - Decision: Accept gap, document, move forward

---

## Immediate Next Steps (Next 30 minutes)

### Step 1: Player Boxscore Backfill (~14 min)
**Priority:** üî¥ CRITICAL - Blocks Phase 3 analytics

```bash
# Current: 13 dates
# Target: 853 dates
# Time: ~14 minutes (1s rate limit)

python backfill_jobs/scrapers/nbac_player_boxscore/nbac_player_boxscore_scraper_backfill.py \
  --service-url=https://nba-phase1-scrapers-756957797294.us-west2.run.app
```

**On completion:**
- Update `data-coverage-tracker.md` with new count
- Verify GCS folders: `gsutil ls gs://nba-scraped-data/nba-com/player-boxscore/ | wc -l`
- Expected: ~853 folders

### Step 2: BDL Standings Backfill (~6 sec)
**Priority:** üü° HIGH - Quick win, enables standings features

```bash
# Current: 2 seasons (2024, 2025)
# Target: 4 seasons (2021, 2022, 2023, 2024)
# Time: ~6 seconds (3 API calls)

python backfill_jobs/scrapers/bdl_standings/bdl_standings_scraper_backfill.py \
  --service-url=https://nba-phase1-scrapers-756957797294.us-west2.run.app
```

**On completion:**
- Update `data-coverage-tracker.md`
- Verify BigQuery: Check `nba_raw.bdl_standings` for 2021-2023 data

### Step 3: Verification & Documentation
```bash
# Verify player boxscore coverage
gsutil ls gs://nba-scraped-data/nba-com/player-boxscore/ | wc -l
# Expected: ~853

# Verify BDL standings
bq query --use_legacy_sql=false "
  SELECT season, COUNT(*) as records
  FROM \`nba-props-platform.nba_raw.bdl_standings\`
  GROUP BY season
  ORDER BY season
"
# Expected: 2021, 2022, 2023, 2024 all present
```

**Update tracker:**
- Edit `docs/09-handoff/data-coverage-tracker.md`
- Mark player boxscore: ‚úÖ DONE
- Mark BDL standings: ‚úÖ DONE
- Update coverage percentages

---

## Short-Term Work (This Week)

### Day 1 (Today) - After Backfills Complete
- [ ] Wait 90 minutes for streaming buffer to clear
- [ ] Run Phase 2 processors (process GCS ‚Üí BigQuery)
  ```bash
  # Process team boxscore data
  python -m data_processors.raw.nbacom.nbac_team_boxscore_processor

  # Process player boxscore data
  python -m data_processors.raw.nbacom.nbac_player_boxscore_processor
  ```
- [ ] Verify Phase 2 completion

### Day 2-3 - Analytics Processing
- [ ] Run Phase 3 processors
  ```bash
  python -m data_processors.analytics.player_game_summary.player_game_summary_processor
  python -m data_processors.analytics.team_offense_game_summary.team_offense_game_summary_processor
  python -m data_processors.analytics.team_defense_game_summary.team_defense_game_summary_processor
  ```
- [ ] Verify Phase 3 completion
- [ ] Test sample queries

### Day 4-5 - Feature Generation
- [ ] Run Phase 4 processors
- [ ] Verify feature data quality
- [ ] Test Phase 5 predictions with real historical data

---

## Medium-Term Work (Next 2 Weeks)

### Week 1: Streaming Buffer Migration
**Why first:** Prerequisite for source coverage, prevents future backfill errors

1. Review `docs/05-development/guides/bigquery-best-practices.md`
2. Update base processor classes
   - Change: `insert_rows_json()` ‚Üí `load_table_from_json()`
3. Test with one processor
4. Roll out to ~20 processors
5. Document changes

**Estimated time:** 4-6 hours

### Week 2: Optional Backfills
**If time permits:**

- GetNbaComPlayByPlay (~88 min, 5,299 games)
- GetEspnBoxscore (~132 min, 5,299 games)
- OddsAPI historical lines (~104 playoff dates)

**Decision point:** Are these needed immediately, or can they wait?

---

## Long-Term Work (Next Sprint)

### Source Coverage Implementation (3-4 weeks)

**Week 1: Foundation**
- Create `source_coverage_log` table
- Add quality columns to key tables
- Implement basic QualityMixin

**Week 2: Fallback & Propagation**
- Implement FallbackSourceMixin
- Quality propagation Phase 3 ‚Üí 4
- Test with 10 games

**Week 3: Alerts & Monitoring**
- Alert system integration
- Daily digest emails
- Dashboard queries

**Week 4: Audit & Historical**
- Coverage audit job
- Game summary view
- Historical backfill of quality scores

**When implemented:**
- 6 Play-In games will be auto-detected
- Logged as `event_type: 'silent_failure'`
- Added to coverage log with `is_synthetic: TRUE`

---

## Decision Points & Open Questions

### Decision 1: Streaming Buffer Migration Timing
**Question:** Do we fix streaming buffer before or after remaining backfills?

**Option A - Before:**
- ‚úÖ Prevents errors during backfills
- ‚ùå Delays getting data into pipeline
- Time: +4-6 hours before backfills

**Option B - After:**
- ‚úÖ Get data flowing faster
- ‚ùå May see 100+ streaming buffer errors
- Time: Can fix at leisure

**Recommendation:** Option B - Get data first, fix infrastructure after

### Decision 2: ESPN & Play-by-Play Backfills
**Question:** Are these critical or nice-to-have?

**Context:**
- ESPN boxscores = backup source (for source coverage)
- Play-by-Play = enables advanced features (shot charts, etc.)
- Both require ~3.5 hours combined

**Recommendation:** Defer until after Phase 3/4 are working

### Decision 3: Source Coverage Implementation Priority
**Question:** Implement source coverage this sprint or next?

**Context:**
- Full implementation = 3-4 weeks
- Requires streaming buffer fix first
- Current gap tracking may be sufficient short-term

**Recommendation:** Next sprint, after streaming buffer migration

---

## Documentation Index

All documentation is consolidated under `docs/09-handoff/`:

| Document | Purpose | Status |
|----------|---------|--------|
| `GAME-PLAN-2025-11-26.md` | This document - overall strategy | ‚úÖ Active |
| `known-data-gaps.md` | Detailed gap analysis & resolution | ‚úÖ Living doc |
| `data-coverage-tracker.md` | Real-time coverage tracking | ‚úÖ Living doc |
| `2025-11-25-scraper-backfill-plan.md` | Original backfill plan | ‚úÖ Reference |
| `2025-11-26-source-coverage-design.md` | Backfill status & design notes | ‚úÖ Reference |
| `2025-11-26-source-coverage-implementation.md` | Implementation guide | ‚úÖ Reference |

**Architecture docs:**
- `docs/architecture/source-coverage/` (6 files)

**Project tracking:**
- `docs/08-projects/current/streaming-buffer-migration/`

---

## Success Metrics

### Today's Success
- [x] Team boxscore: 99.9% complete
- [x] Gap documentation: Complete
- [ ] Player boxscore: 100% complete
- [ ] BDL standings: 100% complete

### This Week's Success
- [ ] Phase 2 processing: Complete
- [ ] Phase 3 analytics: Working with real data
- [ ] No critical gaps undocumented

### This Sprint's Success
- [ ] Streaming buffer: Fixed
- [ ] Phase 4 features: Generated
- [ ] Phase 5 predictions: Using real historical data

---

## Risk Management

### Risk 1: Streaming Buffer Errors During Phase 2
**Probability:** High (already saw 101 errors)
**Impact:** Medium (processing works, just need to wait 90min)
**Mitigation:** Wait 90 minutes between backfill completion and Phase 2 processing

### Risk 2: More Source Gaps Discovered
**Probability:** Medium (may find issues in player boxscore)
**Impact:** Low (we have documentation system now)
**Mitigation:** Use `known-data-gaps.md` to track

### Risk 3: Phase 3 Processors Fail on Historical Data
**Probability:** Low-Medium
**Impact:** High (blocks predictions)
**Mitigation:** Test with sample games before full processing

---

## Communication Plan

### Status Updates
**After each major milestone:**
1. Update `data-coverage-tracker.md`
2. Note completion in session notes
3. Document any new gaps in `known-data-gaps.md`

### Handoff to Next Session
**At end of session, create:**
- `NEXT_SESSION.md` with current status
- Update all trackers
- Clear todo list or note outstanding items

---

## Quick Reference Commands

### Check Coverage
```bash
# Team boxscore GCS folders
gsutil ls gs://nba-scraped-data/nba-com/team-boxscore/ | wc -l

# Player boxscore GCS folders
gsutil ls gs://nba-scraped-data/nba-com/player-boxscore/ | wc -l

# BDL standings seasons
bq query --use_legacy_sql=false "
  SELECT season, COUNT(*) FROM nba_raw.bdl_standings
  GROUP BY season ORDER BY season
"
```

### Run Backfills
```bash
# Player boxscore
cd /home/naji/code/nba-stats-scraper
python backfill_jobs/scrapers/nbac_player_boxscore/nbac_player_boxscore_scraper_backfill.py \
  --service-url=https://nba-phase1-scrapers-756957797294.us-west2.run.app

# BDL standings
python backfill_jobs/scrapers/bdl_standings/bdl_standings_scraper_backfill.py \
  --service-url=https://nba-phase1-scrapers-756957797294.us-west2.run.app
```

### Process Data
```bash
# Phase 2 (after 90min wait)
python -m data_processors.raw.nbacom.nbac_team_boxscore_processor
python -m data_processors.raw.nbacom.nbac_player_boxscore_processor

# Phase 3
python -m data_processors.analytics.player_game_summary.player_game_summary_processor
```

---

## Conclusion

We've successfully:
1. ‚úÖ Completed team boxscore backfill (99.9%)
2. ‚úÖ Applied source coverage principles to real gap
3. ‚úÖ Created comprehensive gap tracking system
4. ‚úÖ Documented everything we're moving past

**Next up:** Player boxscore backfill (~14 min) + BDL standings (~6 sec)

**Nothing is getting lost.** Every gap is documented, every decision is tracked.

---

**Last Updated:** 2025-11-26 Evening
**Next Review:** After backfills complete
