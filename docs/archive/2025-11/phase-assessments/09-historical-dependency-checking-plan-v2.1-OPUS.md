# Historical Dependency Checking - Implementation Plan (v2.1)

**Source:** Opus AI Review (Web-based)
**Date:** 2025-11-22
**Status:** Under Evaluation
**Scope:** Phase 3, Phase 4, potentially Phase 5

---

## Document Purpose

This implementation plan was generated by Opus AI after reviewing:
- Current Phase 3/4/5 processor architecture
- Historical dependency checking requirements
- Backfill scenarios (4-year historical data)
- Multi-window processing challenges

**Note:** Full document content provided by user in previous session. Key components summarized below from conversation history:

---

## Key Components (Summary)

### 1. Completeness Checking Service
- **CompletenessChecker** service with batch queries for all entities
- Simple completeness percentage (0-100%) instead of complex quality tiers
- Production-ready boolean flag based on 90% threshold

### 2. Circuit Breaker Pattern
- Max 3 reprocessing attempts per entity/date
- 7-day minimum gap between reprocess attempts
- Prevents reprocessing oscillation

### 3. Multi-Window Logic
- ALL windows must be complete for production-ready status
- Example: player_daily_cache requires L5, L7, L10, L14 - if any missing, not production-ready
- Very conservative approach ensuring data quality

### 4. Decision Visibility Schema
- Track ALL processing attempts (success + skip)
- Enables debugging "why didn't this process?"
- Historical audit trail

### 5. Season Boundary Detection
- Prevent false alerts when new NBA season starts
- Recognize expected data gaps at season transitions

### 6. Hybrid Reprocessing Strategy
- **Automatic**: For last 60 days (recent data)
- **Manual**: For 4-year historical backfill
- Reduces noise, focuses automation on high-value recent data

### 7. Concrete Alert Thresholds
- Day 10: 30% completeness expected
- Day 20: 80% completeness expected
- Day 30: 95% completeness expected
- Clear signals for when backfill falling behind

### 8. Schedule-Based Completeness
- Compare expected games (from `nbac_schedule`) vs actual games (from upstream tables)
- Knows exactly what SHOULD exist vs what DOES exist

---

## Schema Impact

### New Columns Per Phase 4 Table (14 columns):
1. `expected_games_count` INT64
2. `actual_games_count` INT64
3. `completeness_percentage` FLOAT64
4. `missing_games_count` INT64
5. `is_production_ready` BOOLEAN
6. `data_quality_issues` ARRAY<STRING>
7. `last_reprocess_attempt_at` TIMESTAMP
8. `reprocess_attempt_count` INT64
9. `circuit_breaker_active` BOOLEAN
10. `circuit_breaker_until` TIMESTAMP
11. `manual_override_required` BOOLEAN
12. `season_boundary_detected` BOOLEAN
13. `backfill_bootstrap_mode` BOOLEAN
14. `processing_decision_reason` STRING

### Total Schema Impact:
- 5 Phase 4 processors × 14 columns = 70 new columns
- Additional 9 columns for multi-window processors (player_daily_cache)
- **Total: 79 new columns across Phase 4**

---

## Cost Estimate

- Completeness checking queries: ~$2.60/month
- Storage: negligible (boolean flags and counters)
- **Total additional cost: ~$2.60/month**

---

## Implementation Timeline

### Optimistic (from document):
- 6-7 weeks total

### Realistic Assessment:
- **8-10 weeks** (with 1 engineer)

### Staged Approach:
- **Week 1**: Core infrastructure + team_defense_zone_analysis
- **Week 2**: Test with 1 month of data, validate approach
- **Week 3**: player_daily_cache (multi-window complexity)
- **Week 4**: Remaining 3 Phase 4 processors
- **Week 5**: Monitoring infrastructure (6 BigQuery views + daily job)
- **Week 6-7**: Backfill 4 years of historical data
- **Week 8-10**: Buffer for edge cases, testing, production hardening

---

## Integration Testing Checklist

### Week 1 (Day 0-10 Backfill):
- ✅ Bootstrap mode active (expected_games_count = 0 acceptable)
- ✅ Partial data handling (5 games when need 10)
- ✅ Early season flags set correctly

### Week 2 (Day 10-30 Backfill):
- ✅ Completeness percentage climbing (30% → 80%)
- ✅ Production-ready transitions (FALSE → TRUE at 90%)
- ✅ Alert thresholds working

### Week 3 (Day 30+ Backfill):
- ✅ Historical window detection (game in L15 corrected)
- ✅ Cascade reprocessing (Phase 4 → Phase 4 dependencies)
- ✅ Multi-window ALL-complete logic

### Week 4 (Recent Data):
- ✅ Automatic reprocessing (last 60 days)
- ✅ Circuit breaker triggering (max 3 attempts)
- ✅ Manual override required after circuit breaker

---

## Rollback Plan

### Option 1: Feature Flag Disable
- Set `ENABLE_COMPLETENESS_CHECKING=false`
- Revert to current behavior (process all entities)
- Zero downtime

### Option 2: Schema Rollback
- Remove new columns via ALTER TABLE
- Requires brief downtime (~5 minutes)

### Option 3: Full Rollback
- Revert to previous git commit
- Redeploy previous revision
- ~15 minutes downtime

---

## Phase Applicability (Original Scope)

### Phase 4 (5 processors): ✅ FULLY APPLICABLE
- team_defense_zone_analysis (L15 games)
- player_shot_zone_analysis (L10/L20 games)
- player_daily_cache (L5/L7/L10/L14 mixed windows)
- player_composite_factors (cascade dependencies)
- ml_feature_store (cascade dependencies)

### Phase 5 (Predictions): ✅ ADDRESSED
- Decision visibility schema tracks prediction runs
- Same completeness checking applies to upstream Phase 4 data

### Phase 3 (Analytics): ⚠️ NOT ADDRESSED IN ORIGINAL DOCUMENT
- **Gap identified**: User wants this for Phase 3 as well
- Needs separate assessment (see todo)

---

## Open Questions

1. **Phase 3 Applicability**: Does Phase 3 have historical dependencies requiring completeness checking?
2. **Multi-Window Conservative Approach**: Is requiring ALL windows at 90% too strict?
3. **Backfill Timeline**: Is 750K records in 2 weeks realistic?
4. **Phase 3 Coordination**: When Phase 3 reprocesses, should Phase 4 auto-reprocess?

---

## Next Steps

1. ✅ Save this document (done)
2. ⏳ Assess Phase 3 processor historical dependencies
3. ⏳ Determine implementation approach (full plan vs prototype)
4. ⏳ Get user approval on scope (Phase 3 + 4 vs Phase 4 only)

---

## References

- `/docs/for-review/OPUS_REVIEW_historical-dependency-checking.md` - Input document for Opus
- `/docs/implementation/05-phase4-historical-dependencies-complete.md` - Phase 4 analysis
- `/docs/implementation/07-historical-dependency-checking-no-schema.md` - Query-based alternative
- `/docs/implementation/08-data-completeness-checking-strategy.md` - Three approaches
