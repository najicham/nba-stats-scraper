# NBA Props Orchestration - Schedule System

`bin/orchestration/README.md`

**Understanding the Three-Layer Schedule System**

---

## üìÖ The Three Layers

### Layer 1: Workflow Definitions (config/workflows.yaml)
**What it defines:** Business logic - when each workflow SHOULD run

```yaml
workflows:
  morning_operations:
    decision_type: self_aware
    schedule:
      ideal_window:
        start_hour: 5  # Prefer 5-7 AM ET
        end_hour: 7
  
  betting_lines:
    decision_type: game_aware
    schedule:
      window_before_game_hours: 6  # Start 6h before first game
      frequency_hours: 2            # Run every 2 hours
      business_hours:
        start: 8  # Only between 8 AM
        end: 20   # and 8 PM
```

**Location:** `config/workflows.yaml`  
**Edited by:** You (when changing workflow behavior)  
**Used by:** Master controller to make decisions

---

### Layer 2: Orchestration Schedules (bin/orchestration/deploy.sh)
**What it defines:** Infrastructure - when orchestration components run

```bash
# Master Controller: Checks workflows every hour 6 AM-11 PM ET
create_or_update_scheduler_job \
    "master-controller-hourly" \
    "0 6-23 * * *" \
    "${SERVICE_URL}/evaluate-workflows" \
    "300"

# Schedule Locker: Runs once daily at 5 AM ET
create_or_update_scheduler_job \
    "daily-schedule-locker" \
    "0 10 * * *" \  # 10 UTC = 5 AM ET
    "${SERVICE_URL}/generate-daily-schedule" \
    "180"

# Cleanup Processor: Runs every 15 minutes
create_or_update_scheduler_job \
    "cleanup-processor" \
    "*/15 * * * *" \
    "${SERVICE_URL}/run-cleanup" \
    "180"
```

**Location:** `bin/orchestration/deploy.sh` (lines 130-160)  
**Edited by:** You (when changing orchestration timing)  
**Used by:** Cloud Scheduler to trigger Cloud Run endpoints

---

### Layer 3: Daily Expected Schedule (BigQuery)
**What it defines:** Today's plan - what SHOULD execute today

Generated at 5 AM ET by reading Layer 1 + today's game schedule:

```sql
-- Records created in: nba_orchestration.daily_expected_schedule
INSERT INTO daily_expected_schedule VALUES
  ('2025-11-11', 'morning_operations', '2025-11-11 11:00:00 UTC', ...),
  ('2025-11-11', 'betting_lines', '2025-11-11 16:00:00 UTC', ...),
  ('2025-11-11', 'betting_lines', '2025-11-11 18:00:00 UTC', ...);
```

**Location:** BigQuery `nba_orchestration.daily_expected_schedule`  
**Generated by:** Schedule locker (reads workflows.yaml + game schedule)  
**Used by:** Grafana dashboards for monitoring

---

## üîÑ How They Work Together

### Daily Flow:

```
5:00 AM ET
  ‚Üì
Schedule Locker runs (Layer 2 triggers it)
  ‚Üì
Reads workflows.yaml (Layer 1) + game schedule
  ‚Üì
Generates daily_expected_schedule in BigQuery (Layer 3)
  ‚Üì
6:00 AM ET onwards
  ‚Üì
Master Controller runs hourly (Layer 2 triggers it)
  ‚Üì
Reads workflows.yaml (Layer 1)
  ‚Üì
Makes decision: Should betting_lines run now?
  ‚Üì
Records decision in workflow_decisions table
  ‚Üì
Grafana compares expected (Layer 3) vs actual (decisions)
```

---

## üìù When to Edit What

### Scenario 1: Change when betting_lines runs
**Edit:** `config/workflows.yaml`
```yaml
betting_lines:
  schedule:
    window_before_game_hours: 8  # Changed from 6 to 8
```
**Restart needed?** No, master controller reads this on every evaluation

---

### Scenario 2: Change when master controller runs
**Edit:** `bin/orchestration/deploy.sh` lines 145-149
```bash
create_or_update_scheduler_job \
    "master-controller-hourly" \
    "0 5-22 * * *" \  # Changed from 6-23 to 5-22
```
**Deploy:** `./bin/orchestration/deploy.sh --update`

---

### Scenario 3: Add new workflow
**Edit:** `config/workflows.yaml`
```yaml
workflows:
  # ... existing workflows ...
  
  injury_update:  # New!
    scrapers: ['nbac_injury_report']
    decision_type: discovery
    schedule:
      max_attempts_per_day: 6
```
**Restart needed?** No, next schedule locker run (5 AM) will pick it up

---

## üõ†Ô∏è Scripts in This Directory

### Monitoring & Health Checks

#### quick_health_check.sh ‚≠ê START HERE
**Purpose:** Fast health check (30 seconds) - daily status at a glance

```bash
./bin/orchestration/quick_health_check.sh
```

**Output:** Single-row summary with:
- Scheduled workflows, decisions made (RUN/SKIP/ABORT)
- Execution success rate, scraper success rate
- Health status: ‚úÖ HEALTHY, ‚ö†Ô∏è DEGRADED, ‚ùå UNHEALTHY, or ‚ÑπÔ∏è NO GAMES TODAY

**When to run:** Daily after games to verify orchestration performed correctly

---

#### check_system_status.sh
**Purpose:** Detailed system health check with multiple components

```bash
./bin/orchestration/check_system_status.sh
```

**Checks:**
1. Processor deployment status
2. Pub/Sub queue backlog
3. Recent scraper activity (last hour)
4. Scraper failures with sample errors
5. Pub/Sub publishing events
6. Processor activity
7. Processor errors
8. Dead letter queue status

**When to run:** When investigating issues or getting detailed system health

---

#### verify_phase1_complete.sh
**Purpose:** Comprehensive Phase 1 orchestration verification

```bash
./bin/orchestration/verify_phase1_complete.sh
```

**Verifies:**
- All expected workflows executed
- Scrapers ran successfully
- No missing executions
- Data quality checks

**When to run:** End of day to confirm everything completed

---

#### Other Monitoring Scripts

- **check_missing_executions.sh** - Find workflows that were scheduled but didn't execute
- **view_today_timeline.sh** - Visual timeline of today's orchestration events
- **investigate_scraper_failures.sh** - Deep dive into scraper failures with error analysis
- **verify_pubsub_integration.sh** - Verify Pub/Sub setup and message flow
- **test_orchestration_endpoints.sh** - Test all orchestration HTTP endpoints
- **check_workflow_results.sql** - SQL query for workflow execution results

---

### Deployment & Testing

#### deploy.sh
**Purpose:** Deploy orchestration to Cloud Run + create/update scheduler jobs

```bash
# Full deployment (first time or code changes)
./bin/orchestration/deploy.sh

# Update schedules only (no code changes)
./bin/orchestration/deploy.sh --update
```

**When to run:**
- Initial deployment
- After code changes
- After changing Layer 2 schedules (orchestration timing)

---

#### test.sh
**Purpose:** Test orchestration endpoints

```bash
# Test local Flask service
./bin/orchestration/test.sh --local

# Test Cloud Run service
./bin/orchestration/test.sh
```

**When to run:**
- After code changes (test locally first)
- To verify Cloud Run deployment
- When debugging issues

---

## üîç Viewing Current Schedules

### Cloud Scheduler Jobs (Layer 2):
```bash
# List all scheduler jobs
gcloud scheduler jobs list --location=us-west2

# View specific job details
gcloud scheduler jobs describe master-controller-hourly \
  --location=us-west2
```

### Workflow Definitions (Layer 1):
```bash
# View workflow configurations
cat config/workflows.yaml
```

### Daily Expected Schedule (Layer 3):
```sql
-- View today's expected schedule
SELECT 
  workflow_name,
  expected_run_time,
  reason
FROM `nba-props-platform.nba_orchestration.daily_expected_schedule`
WHERE date = CURRENT_DATE('America/New_York')
ORDER BY expected_run_time;
```

---

## üéØ Common Tasks

### Update Master Controller Schedule
```bash
# Edit deploy.sh line 145-149
vim bin/orchestration/deploy.sh

# Apply changes
./bin/orchestration/deploy.sh --update
```

### Add New Workflow
```bash
# Edit workflows config
vim config/workflows.yaml

# No deployment needed!
# Next day at 5 AM, schedule locker will include it
```

### Manually Trigger Schedule Generation
```bash
# Get service URL
SERVICE_URL=$(gcloud run services describe nba-orchestration-service \
  --region=us-west2 \
  --format="value(status.url)")

# Trigger schedule locker
curl -X POST \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  "${SERVICE_URL}/generate-daily-schedule"
```

### Manually Trigger Master Controller
```bash
curl -X POST \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  "${SERVICE_URL}/evaluate-workflows"
```

---

## üìä Monitoring

**Grafana Query - Expected vs Actual:**
```sql
-- Shows what should have run vs what did run
SELECT 
  expected.workflow_name,
  expected.expected_run_time,
  actual.decision_time,
  CASE 
    WHEN actual.workflow_name IS NULL THEN 'üî¥ MISSING'
    ELSE '‚úÖ RAN'
  END as status
FROM `nba_orchestration.daily_expected_schedule` expected
LEFT JOIN `nba_orchestration.workflow_decisions` actual
  ON expected.workflow_name = actual.workflow_name
  AND DATE(expected.date) = DATE(actual.decision_time)
WHERE expected.date = CURRENT_DATE('America/New_York')
```

---

## üö® Troubleshooting

### Schedule locker didn't run at 5 AM
```bash
# Check Cloud Scheduler job
gcloud scheduler jobs describe daily-schedule-locker --location=us-west2

# Check logs
gcloud logging read \
  "resource.type=cloud_scheduler_job AND resource.labels.job_id=daily-schedule-locker" \
  --limit=10
```

### Master controller not evaluating workflows
```bash
# Check if job is running
gcloud scheduler jobs describe master-controller-hourly --location=us-west2

# Check Cloud Run logs
gcloud logging read \
  "resource.type=cloud_run_revision AND resource.labels.service_name=nba-orchestration-service" \
  --limit=50
```

### Workflows not appearing in expected schedule
```bash
# Check workflows.yaml is valid
python -c "import yaml; print(yaml.safe_load(open('config/workflows.yaml')))"

# Manually trigger schedule generation to debug
curl -X POST \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  "${SERVICE_URL}/generate-daily-schedule"
```

---

## üìö Related Documentation

- **Monitoring Strategy:** `docs/monitoring/nba_props_monitoring_strategy.md`
- **Grafana Setup:** `docs/monitoring/grafana_setup_guide.md`
- **Workflow Config Reference:** `config/workflows.yaml`
- **Deployment Status:** `docs/deployment/deployment_status.md`

---

**Quick Reference Card:**

| What                  | Where                          | How to Change           |
|-----------------------|--------------------------------|-------------------------|
| Workflow logic        | `config/workflows.yaml`        | Edit file               |
| Orchestration timing  | `bin/orchestration/deploy.sh`  | Edit + deploy --update  |
| Today's expected runs | BigQuery table                 | Auto-generated at 5 AM  |

---

**Last Updated:** November 11, 2025  
**Version:** 1.0
