#!/bin/bash

# Daily NBA Prediction Summary to Slack
# Runs daily at 9 AM via Cloud Scheduler
# Queries BigQuery and sends formatted summary to Slack

set -e

PROJECT_ID="nba-props-platform"
DATASET="nba_predictions"
TABLE="player_prop_predictions"
SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"

# Check if Slack webhook is configured
if [ -z "$SLACK_WEBHOOK_URL" ]; then
  echo "ERROR: SLACK_WEBHOOK_URL environment variable not set"
  exit 1
fi

# Query BigQuery for daily summary
echo "Querying BigQuery for daily prediction summary..."
QUERY="
SELECT
  CURRENT_DATE() as report_date,
  system_id,
  COUNT(*) as total_predictions,
  COUNT(DISTINCT player_lookup) as unique_players,
  ROUND(AVG(confidence_score) * 100, 1) as avg_confidence,
  ROUND(MIN(confidence_score) * 100, 1) as min_confidence,
  ROUND(MAX(confidence_score) * 100, 1) as max_confidence,
  COUNTIF(confidence_score = 0.50) as fallback_count,
  COUNTIF(recommendation = 'OVER') as over_count,
  COUNTIF(recommendation = 'UNDER') as under_count,
  COUNTIF(recommendation = 'PASS') as pass_count,
  ROUND(100.0 * COUNTIF(confidence_score = 0.50) / COUNT(*), 1) as fallback_pct
FROM \`${PROJECT_ID}.${DATASET}.${TABLE}\`
WHERE game_date = CURRENT_DATE()
  AND system_id = 'catboost_v8'
GROUP BY system_id
"

RESULT=$(bq query --use_legacy_sql=false --format=json "$QUERY")

# Parse results
TOTAL=$(echo "$RESULT" | jq -r '.[0].total_predictions // 0')
UNIQUE_PLAYERS=$(echo "$RESULT" | jq -r '.[0].unique_players // 0')
AVG_CONF=$(echo "$RESULT" | jq -r '.[0].avg_confidence // 0')
MIN_CONF=$(echo "$RESULT" | jq -r '.[0].min_confidence // 0')
MAX_CONF=$(echo "$RESULT" | jq -r '.[0].max_confidence // 0')
FALLBACK_COUNT=$(echo "$RESULT" | jq -r '.[0].fallback_count // 0')
FALLBACK_PCT=$(echo "$RESULT" | jq -r '.[0].fallback_pct // 0')
OVER_COUNT=$(echo "$RESULT" | jq -r '.[0].over_count // 0')
UNDER_COUNT=$(echo "$RESULT" | jq -r '.[0].under_count // 0')
PASS_COUNT=$(echo "$RESULT" | jq -r '.[0].pass_count // 0')

# Determine status emoji based on metrics
if [ "$TOTAL" -eq 0 ]; then
  STATUS_EMOJI="‚ö†Ô∏è"
  STATUS_TEXT="No Predictions Generated"
elif [ "$(echo "$FALLBACK_PCT > 30" | bc)" -eq 1 ]; then
  STATUS_EMOJI="üö®"
  STATUS_TEXT="High Fallback Rate"
elif [ "$(echo "$FALLBACK_PCT > 10" | bc)" -eq 1 ]; then
  STATUS_EMOJI="‚ö†Ô∏è"
  STATUS_TEXT="Elevated Fallback Rate"
else
  STATUS_EMOJI="‚úÖ"
  STATUS_TEXT="Healthy"
fi

# Format date
REPORT_DATE=$(date +"%Y-%m-%d")

# Build Slack message using Block Kit
MESSAGE=$(cat <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "${STATUS_EMOJI} NBA Daily Prediction Summary"
      }
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Date:*\n${REPORT_DATE}"
        },
        {
          "type": "mrkdwn",
          "text": "*System:*\nCatBoost V8"
        }
      ]
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Total Predictions:*\n${TOTAL}"
        },
        {
          "type": "mrkdwn",
          "text": "*Unique Players:*\n${UNIQUE_PLAYERS}"
        }
      ]
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Avg Confidence:*\n${AVG_CONF}%"
        },
        {
          "type": "mrkdwn",
          "text": "*Range:*\n${MIN_CONF}% - ${MAX_CONF}%"
        }
      ]
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Fallback Predictions:*\n${FALLBACK_COUNT} (${FALLBACK_PCT}%)"
        },
        {
          "type": "mrkdwn",
          "text": "*Status:*\n${STATUS_TEXT}"
        }
      ]
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Recommendations:*\n‚Ä¢ OVER: ${OVER_COUNT}\n‚Ä¢ UNDER: ${UNDER_COUNT}\n‚Ä¢ PASS: ${PASS_COUNT}"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "ü§ñ Generated by NBA Monitoring System | $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        }
      ]
    }
  ]
}
EOF
)

# Send to Slack
echo "Sending summary to Slack..."
curl -X POST -H 'Content-type: application/json' \
  --data "$MESSAGE" \
  "$SLACK_WEBHOOK_URL"

echo "‚úÖ Daily summary sent successfully"
echo "Total Predictions: $TOTAL"
echo "Fallback Rate: $FALLBACK_PCT%"
echo "Status: $STATUS_TEXT"
