# NBA Scrapers - Operational Reference

## Document Purpose

This is the **daily operational reference** for NBA data scrapers. Use this document for:
- **Deployment**: Class names and file locations
- **Debugging**: Parameter requirements and output paths  
- **Monitoring**: Schedules and dependencies
- **Troubleshooting**: API limits and common issues

For **backfill strategy** and **historical data collection**, see the NBA Workflows Reference document.

---

## GCS Storage Configuration

### **Bucket**: `nba-scraped-data`
All scraped data is stored in the **raw scraped data bucket**: `gs://nba-scraped-data/`

### **Directory Structure**
```
gs://nba-scraped-data/
├── ball-dont-lie/           # Ball Don't Lie API data
├── odds-api/                # Odds API data (business critical)
├── bettingpros/             # 🆕 BettingPros historical data (2021-2023)
│   ├── events/              # Game event IDs by date
│   └── player-props/        # Historical prop betting data
│       └── points/          # Points props by date
├── espn/                    # ESPN data
├── nba-com/                 # NBA.com data  
│   ├── gamebooks/           # NBA Game Books PDFs (backfill only)
│   ├── schedule/            # Schedule data
│   ├── player-list/         # Player data
│   └── injury-report/       # Injury reports
├── big-data-ball/           # Enhanced analytics data
├── bigdataball/             # BigDataBall play-by-play
└── basketball_reference/    # Basketball Reference data (name mapping support)
    └── season_rosters/      # Team rosters by season
```

---

## Scraper Categories by Business Purpose

### **Overview**
Scrapers are organized by **business function** and **timing requirements**. This categorization shows **when** and **why** each scraper is used based on actual operational workflows.

### **Timing Definitions**
- **Real-Time**: Revenue-critical data collected every 2 hours (8 AM - 8 PM PT)
- **Daily Setup**: Foundation data collected every morning (8 AM PT)
- **Post-Game**: Game results collected after completion (8 PM & 11 PM PT)
- **Recovery**: Data recovery and final checks (2 AM & 5 AM PT)
- **Backfill**: Historical data collection for model training

---

### **Category: Live Prop Markets** ⭐ **REVENUE CRITICAL**
- **Timing**: **Real-Time** (Every 2 hours, 8 AM - 8 PM PT)
- **Purpose**: Current betting lines for today's games
- **Priority**: **🔴 CORE BUSINESS** - Primary revenue source
- **Business Need**: Collect player prop odds for points betting

#### **Scrapers**
- `GetOddsApiEvents` ⭐ **Must run first**
- `GetOddsApiCurrentEventOdds` ⭐ **Core business data**

#### **Dependencies**: 
- **CRITICAL**: Events must run before Props (provides event IDs)
- **REQUIRES**: Player Intelligence (for team assignments)

#### **Processing Notes**: Sequential dependency - Events → Props → Player lookup integration

---

### **Category: Player Intelligence**
- **Timing**: **Daily Setup** + **Real-Time**
- **Purpose**: Player name → team lookup for prop betting analysis
- **Priority**: **🔴 CRITICAL** - Foundation for all prop betting
- **Business Need**: Convert "Jaylen Wells" to "MEM" when processing Odds API props

#### **Scrapers**
- `GetNbaComPlayerList` ⭐ **Primary source** (Morning + Real-Time)
- `GetNbaComPlayerMovement` - Transaction context (Morning only)
- `BdlActivePlayersScraper` ⭐ **Third-party validation** (Morning + Real-Time)

#### **Dependencies**: None (runs first)
#### **Processing Notes**: 
- **Real-time**: Use current data for team assignments
- **Historical**: Use box scores to determine player's team during specific games

---

### **Category: Player Availability**
- **Timing**: **Daily Setup** + **Real-Time**
- **Purpose**: Determine if player available for prop betting
- **Priority**: **🟡 HIGH** - Affects prop availability and line values
- **Business Need**: Don't offer props on players who are out/questionable

#### **Scrapers**
- `GetNbaComInjuryReport` ⭐ **Official game-specific status** (Morning + Real-Time)
- `BdlInjuriesScraper` - **Backup injury data** (Morning + Real-Time)

#### **Dependencies**: Player Intelligence (for team context)
#### **Processing Notes**: Dual-source injury monitoring for data validation

---

### **Category: Game Scheduling**
- **Timing**: **Daily Setup**
- **Purpose**: When games happen, detect postponements and time changes  
- **Priority**: **🟡 HIGH** - Timing affects all downstream processing
- **Business Need**: Know when to collect props, when games start

#### **Scrapers**
- `GetNbaComScheduleApi` ⭐ **Primary schedule source** (Current season + Backfill)
- `GetNbaComScheduleCdn` - **Backup with monitoring** (Compare vs API)
- `BdlStandingsScraper` - League standings context

#### **Dependencies**: None
#### **Processing Notes**: Dual-source monitoring to detect API vs CDN differences

---

### **Category: Game Results**
- **Timing**: **Post-Game** (8 PM & 11 PM PT)
- **Purpose**: Player/team performance for analysis
- **Priority**: **🟢 MEDIUM** - Analytical foundation
- **Business Need**: Game outcome data for performance analysis

#### **Scrapers**
- `GetNbaComScoreboardV2` ⭐ **Official game scores**
- `BdlBoxScoresScraper` ⭐ **Player and team statistics**

#### **Dependencies**: Game Scheduling (for game timing)
#### **Processing Notes**: Dual scheduling (8 PM early games, 11 PM late games)

---

### **Category: Advanced Analytics**
- **Timing**: **Recovery** (2 AM & 5 AM PT)
- **Purpose**: Detailed performance analysis and predictive modeling
- **Priority**: **🔵 LOW** - Enhancement over basic stats
- **Business Need**: Advanced player performance insights

#### **Scrapers**
- `BigDataBallPbpScraper` ⭐ **Enhanced play-by-play** (BigDataBall CSV files)
- `GetNbaComPlayByPlay` - **Official backup play-by-play**
- `GetEspnScoreboard` - **Alternative scoreboard** (Final check only)
- `GetEspnBoxscore` - **Alternative boxscores** (Final check only)

#### **Dependencies**: Game Results (for game context)
#### **Processing Notes**: Multiple recovery windows, ESPN as final backup

---

### **Category: Data Enhancement**
- **Timing**: **Backfill** (Historical collection) + **Quarterly Updates**
- **Purpose**: Supporting data for improved scraper accuracy and analysis
- **Priority**: **🔵 STRATEGIC** - Foundation for enhanced data quality
- **Business Need**: Improve name mapping accuracy for NBA Gamebook PDF processing

#### **Scrapers**
- `BasketballRefSeasonRoster` ⭐ **Name mapping foundation** (Backfill + Quarterly)

#### **Dependencies**: None (independent historical collection)
#### **Processing Notes**: 
- **Historical**: One-time backfill for 4 seasons (2022-2025)
- **Maintenance**: Quarterly roster updates during NBA season
- **Integration**: Supports `GetNbaComGamebooks` name mapping accuracy

---

### **Category: Historical Backfill** 📋
- **Timing**: **Backfill Workflows** (on-demand)
- **Purpose**: Historical data collection for model training and analysis
- **Priority**: **🔵 STRATEGIC** - Foundation for predictive models
- **Business Need**: Complete historical dataset for prop betting predictions

#### **Scrapers**
- `GetNbaComScheduleApi` ⭐ **Historical schedules** (✅ Phase 1 Complete - 5,583 games)
- `GetNbaComGamebooks` ⭐ **Game books with DNP reasons** (📋 Phase 2 Planned)
- `BettingProsEvents` ⭐ **🆕 Historical game events** (📋 Phase 3 Planned - 2021-2023)
- `BettingProsPlayerProps` ⭐ **🆕 Historical prop betting lines** (📋 Phase 3 Planned - 2021-2023)

#### **Dependencies**: 
- None (independent historical collection)
- **BettingPros Pattern**: Events → Props (same as Odds API pattern)

#### **Processing Notes**: 
- Season-by-season collection, PDF processing for game books
- **🆕 BettingPros Coverage**: Fills historical gap before Odds API (pre-May 2023)
- **🆕 Rate Limited**: 2.5 second delays for respectful API usage
- **🆕 Pagination**: Automatic page consolidation (points: ~4 pages, ~40 props per date)

---

## Complete Scraper Inventory

### **Total Active Scrapers: 20** (+2 🆕)
- **Odds API**: 2 scrapers (events, props - revenue critical)
- **🆕 BettingPros**: 2 scrapers (historical events, historical props - 2021-2023 backfill)
- **NBA.com**: 7 scrapers (schedule, player data, injuries, scoreboards, play-by-play, **gamebooks**)
- **Ball Don't Lie**: 4 scrapers (active players, injuries, standings, box scores)
- **BigDataBall**: 1 scraper (enhanced play-by-play)
- **ESPN**: 2 scrapers (scoreboard, boxscores - backup only)
- **Basketball Reference**: 1 scraper (name mapping support)
- **BigDataBall**: 1 scraper (enhanced play-by-play from CSV files)

---

## Detailed Scraper Reference

### **🆕 BettingPros (2 Scrapers)** 📋 **HISTORICAL BACKFILL**

#### BettingProsEvents ⭐ **HISTORICAL FOUNDATION**
- **File**: `scrapers/bettingpros/bp_events.py`
- **Class**: `BettingProsEvents`
- **Parameters**: `date` (YYYY-MM-DD format)
- **Output Path**: `/bettingpros/events/{date}/{timestamp}.json`
- **Schedule**: Backfill workflows only (Phase 3 - Historical prop data collection)
- **Purpose**: Historical NBA game event IDs for prop data collection (2021-2023)
- **API Details**: Single response per date, ~3-5 events per date, includes lineups and venue data
- **Dependencies**: **NONE - MUST RUN FIRST** (provides event IDs for props scraper)
- **Rate Limiting**: 2.0 second delay per request
- **Coverage**: October 2021 → May 2023 (fills gap before Odds API)

#### BettingProsPlayerProps ⭐ **HISTORICAL PROP LINES**
- **File**: `scrapers/bettingpros/bp_player_props.py`
- **Class**: `BettingProsPlayerProps`
- **Parameters**: `date` (auto-fetches events) OR `event_ids` (comma-separated)
- **Output Path**: `/bettingpros/player-props/{market_type}/{date}/{timestamp}.json`
- **Schedule**: Backfill workflows only (Phase 3 - Historical prop data collection)
- **Purpose**: Historical NBA player prop betting lines with sportsbook odds (2021-2023)
- **API Details**: **Paginated response** (~4 pages × 10 props = ~40 props per date)
- **Dependencies**: **REQUIRES BettingProsEvents** OR manual event IDs
- **Rate Limiting**: 2.5 second delay between pages
- **Market Support**: Points props (primary), Rebounds/Assists/etc. (secondary)
- **Sportsbook Coverage**: BetMGM, FanDuel, DraftKings, Caesars, bet365, etc.

### **🆕 BettingPros API Details**
- **Rate Limit**: 10 items per page (API maximum), respectful delays implemented
- **Authentication**: API key via `X-Api-Key` header (included in scraper)
- **Data Format**: JSON with complex nested sportsbook structure
- **Reliability**: Stable for historical data, some edge cases on final pages
- **Coverage Period**: October 2021 → May 2023 (pre-Odds API era)
- **Business Value**: Fills ~18-month gap for historical prop betting analysis

### **🆕 BettingPros Backfill Strategy**
- **Phase 3A**: Events collection (~600 dates × 2 seconds = ~20 minutes)
- **Phase 3B**: Props collection (~600 dates × 4 pages × 2.5 seconds = ~2.5 hours)
- **Total Volume**: ~600 dates × 40 props = **~24,000 historical prop bets**
- **Resumable**: Skip dates already in GCS
- **Monitoring**: Progress tracking per month/season
- **Priority**: Points props only (rebounds/assists optional)

---

### **Odds API (2 Scrapers)** ⭐ **REVENUE CRITICAL**

#### GetOddsApiEvents ⭐ **CRITICAL**
- **File**: `scrapers/oddsapi/oddsa_events.py`
- **Class**: `GetOddsApiEvents`
- **Parameters**: None
- **Output Path**: `/odds-api/events/{date}/{timestamp}.json`
- **Schedule**: Real-Time Business workflow (every 2 hours, 8 AM - 8 PM PT)
- **Purpose**: Current/upcoming NBA games for prop collection
- **API Details**: Single response, ~5-15 events per day
- **Dependencies**: **NONE - MUST RUN FIRST**

#### GetOddsApiCurrentEventOdds ⭐ **CORE BUSINESS**
- **File**: `scrapers/oddsapi/oddsa_player_props.py`
- **Class**: `GetOddsApiCurrentEventOdds`
- **Parameters**: `event_id`
- **Output Path**: `/odds-api/player-props/{date}/event_{id}/{timestamp}.json`
- **Schedule**: Real-Time Business workflow (30 minutes after Events API)
- **Purpose**: Player prop odds for FanDuel + DraftKings
- **API Details**: Response per event, ~20-50 props per game
- **Dependencies**: **REQUIRES GetOddsApiEvents to run first**

### **Odds API Limits**
- **Rate Limit**: 500 requests per month (paid plan)
- **Authentication**: API key via `ODDS_API_KEY` environment variable
- **Critical**: Events API must run before Props API

---

### **NBA.com (7 Scrapers)**

#### GetNbaComPlayerList ⭐ **CRITICAL FOR PLAYER LOOKUP**
- **File**: `scrapers/nbacom/nbac_player_list.py`
- **Class**: `GetNbaComPlayerList`
- **Parameters**: None (current season auto-filtered)
- **Output Path**: `/nba-com/player-list/{date}/{timestamp}.json`
- **Schedule**: Morning Operations + Real-Time Business workflows
- **Purpose**: Official master player database for team assignments
- **API Details**: Single response, ~500 active players, 293KB file
- **Dependencies**: None

#### GetNbaComScheduleApi ⭐ **DUAL PURPOSE**
- **File**: `scrapers/nbacom/nbac_schedule_api.py`
- **Class**: `GetNbaComScheduleApi`
- **Parameters**: `season` (for backfill) or None (for current season)
- **Output Path**: `/nba-com/schedule/{actual_season_nba_format}/{timestamp}.json`
- **Schedule**: Morning Operations workflow (daily at 8 AM PT) + Backfill workflows
- **Purpose**: Current season schedule + historical backfill capability
- **API Details**: Single response, ~3.3MB file with full season
- **Dependencies**: None

#### GetNbaComScheduleCdn
- **File**: `scrapers/nbacom/nbac_schedule_cdn.py`
- **Class**: `GetNbaComScheduleCdn`
- **Parameters**: None (current season auto-detected)
- **Output Path**: `/nba-com/schedule-cdn/{actual_season_nba_format}/{timestamp}.json`
- **Schedule**: Morning Operations workflow (backup to API version)
- **Purpose**: Compare CDN vs API schedule data for monitoring
- **API Details**: Single response, ~3.3MB file
- **Dependencies**: None

#### GetNbaComInjuryReport ⭐ **CRITICAL FOR PROPS**
- **File**: `scrapers/nbacom/nbac_injury_report.py`
- **Class**: `GetNbaComInjuryReport`
- **Parameters**: `date`, `hour`
- **Output Path**: `/nba-com/injury-report/{date}/{hour}{period}/{timestamp}.json`
- **Schedule**: Morning Operations + Real-Time Business workflows
- **Purpose**: Official NBA injury report with game-specific availability
- **API Details**: JSON format (converted from PDF), ~50-100 players per report
- **Dependencies**: None

#### GetNbaComScoreboardV2
- **File**: `scrapers/nbacom/nbac_scoreboard_v2.py`
- **Class**: `GetNbaComScoreboardV2`
- **Parameters**: `scoreDate`
- **Output Path**: `/nba-com/scoreboard-v2/{date}/{timestamp}.json`
- **Schedule**: Post-Game Collection workflow (8 PM & 11 PM PT)
- **Purpose**: Game scores with quarter-by-quarter data and team stats
- **API Details**: Single response per date
- **Dependencies**: None
- **Warning**: May be deprecated by NBA.com in future

#### GetNbaComPlayByPlay
- **File**: `scrapers/nbacom/nbac_play_by_play.py`
- **Class**: `GetNbaComPlayByPlay`
- **Parameters**: `gameId`
- **Output Path**: `/nba-com/play-by-play/{date}/game_{gameId}/{timestamp}.json`
- **Schedule**: Late Night Recovery + Early Morning Final Check workflows
- **Purpose**: Official play-by-play backup to BigDataBall
- **API Details**: ~500-800 events per game, large JSON files
- **Dependencies**: Requires NBA.com game IDs

#### GetNbaComPlayerMovement
- **File**: `scrapers/nbacom/nbac_player_movement.py`
- **Class**: `GetNbaComPlayerMovement`
- **Parameters**: `year`
- **Output Path**: `/nba-com/player-movement/{date}/{timestamp}.json`
- **Schedule**: Morning Operations workflow (daily at 8 AM PT)
- **Purpose**: Complete transaction history (trades, signings, waivers, G-League)
- **API Details**: 8,730+ records back to 2015, large file
- **Dependencies**: None

#### GetNbaComGamebooks ⭐ **BACKFILL CRITICAL**
- **File**: `scrapers/nbacom/nbac_gamebooks.py`
- **Class**: `GetNbaComGamebooks`
- **Parameters**: `date`
- **Output Path**: `/nba-com/gamebooks/{season}/{date}/{timestamp}.json`
- **Schedule**: Backfill workflows only (Phase 2)
- **Purpose**: Official NBA game books with complete box scores + DNP reasons
- **API Details**: PDF processing, ~2-6 games per date, comprehensive player data
- **Dependencies**: None (uses known game dates from Phase 1 schedule collection)
- **Special Features**: 
  - **DNP Context**: Injury, rest, coach's decision, personal reasons
  - **Complete Box Scores**: All statistical categories
  - **Official Source**: Authoritative game documentation
- **Technical Requirements**: PDF parsing library (PyPDF2/pdfplumber/tabula-py)
- **Backfill Scope**: ~173,000 player records across 5,583 historical games

### **NBA.com API Details**
- **Rate Limit**: No official limit, but be respectful
- **Authentication**: None required for most endpoints
- **Data Format**: Varies (JSON objects, array format, nested structures, **PDFs for gamebooks**)
- **Reliability**: Official source, generally very reliable

---

### **Ball Don't Lie API (4 Scrapers)**

#### BdlActivePlayersScraper ⭐ **CRITICAL FOR PLAYER VALIDATION**
- **File**: `scrapers/balldontlie/bdl_active_players.py`
- **Class**: `BdlActivePlayersScraper`
- **Parameters**: None
- **Output Path**: `/ball-dont-lie/active-players/{date}/{timestamp}.json`
- **Schedule**: Morning Operations + Real-Time Business workflows
- **Purpose**: Cross-validate NBA.com player data, detect team assignment discrepancies
- **API Details**: **Paginated, 5-6 requests required**, ~100 players per page, ~500 total active players
- **Dependencies**: None (independent validation source)
- **Special Notes**: Single Cloud Run instance handles all pagination, aggregated into one output file

#### BdlInjuriesScraper
- **File**: `scrapers/balldontlie/bdl_injuries.py`
- **Class**: `BdlInjuriesScraper`
- **Parameters**: None
- **Output Path**: `/ball-dont-lie/injuries/{date}/{timestamp}.json`
- **Schedule**: Morning Operations + Real-Time Business workflows (backup to NBA.com)
- **Purpose**: Alternative injury status source for data validation
- **API Details**: Single response, all injured players
- **Dependencies**: None

#### BdlStandingsScraper
- **File**: `scrapers/balldontlie/bdl_standings.py`
- **Class**: `BdlStandingsScraper`
- **Parameters**: None
- **Output Path**: `/ball-dont-lie/standings/{date}/{timestamp}.json`
- **Schedule**: Morning Operations workflow (daily at 8 AM PT)
- **Purpose**: Current league standings for context
- **API Details**: Single response, all team standings
- **Dependencies**: None

#### BdlBoxScoresScraper
- **File**: `scrapers/balldontlie/bdl_box_scores.py`
- **Class**: `BdlBoxScoresScraper`
- **Parameters**: `date`
- **Output Path**: `/ball-dont-lie/boxscores/{date}/{timestamp}.json`
- **Schedule**: Post-Game Collection + Late Night Recovery + Early Morning Final Check workflows
- **Purpose**: Team boxscores with embedded player stats
- **API Details**: Single response with all games for date
- **Dependencies**: None
- **Note**: **Lacks DNP reasons** - use `GetNbaComGamebooks` for complete context

### **Ball Don't Lie API Limits**
- **Rate Limit**: 600 requests per minute
- **Authentication**: Bearer token via `BDL_API_KEY` environment variable
- **Pagination**: 100 items per page (Active Players endpoint requires 5-6 requests)

---

### **BigDataBall (1 Scraper)**

#### BigDataBallPbpScraper
- **File**: `scrapers/bigdataball/bigdataball_pbp.py`
- **Class**: `BigDataBallPbpScraper`
- **Parameters**: `game_id`
- **Output Path**: `/big-data-ball/{nba_season}/{date}/game_{game_id}/{filename}.csv`
- **Schedule**: Late Night Recovery + Early Morning Final Check workflows
- **Purpose**: Enhanced play-by-play with lineup tracking and advanced coordinates
- **API Details**: Google Drive CSV files, 40+ fields per event, ~500-800 events per game
- **Dependencies**: Games must be completed, requires Google Drive API access
- **Special**: Requires Google Drive API and service account authentication

---

### **ESPN (2 Scrapers)** - **BACKUP ONLY**

#### GetEspnScoreboard
- **File**: `scrapers/espn/espn_scoreboard_api.py`
- **Class**: `GetEspnScoreboard`
- **Parameters**: `game_date`
- **Output Path**: `/espn/scoreboard/{date}/{timestamp}.json`
- **Schedule**: Early Morning Final Check workflow only (5 AM PT)
- **Purpose**: Alternative scoreboard data as final backup
- **API Details**: Single response with all games for date
- **Dependencies**: None

#### GetEspnBoxscore
- **File**: `scrapers/espn/espn_game_boxscore.py`
- **Class**: `GetEspnBoxscore`
- **Parameters**: `game_id`
- **Output Path**: `/espn/boxscores/{date}/game_{id}/{timestamp}.json`
- **Schedule**: Early Morning Final Check workflow only (5 AM PT)
- **Purpose**: Alternative boxscore data as final backup
- **API Details**: One request per completed game
- **Dependencies**: Requires ESPN game IDs from scoreboard

### **ESPN API Details**
- **Rate Limit**: No official limit, reasonable usage recommended
- **Authentication**: None required
- **Data Format**: Consistent JSON responses
- **Usage**: Backup data source only, not primary operational data

---

### **Basketball Reference (1 Scraper)** - **DATA ENHANCEMENT**

#### BasketballRefSeasonRoster ⭐ **NAME MAPPING FOUNDATION**
- **File**: `scrapers/basketball_ref/br_season_roster.py`
- **Class**: `BasketballRefSeasonRoster`
- **Parameters**: `teamAbbr`, `year` (ending year: 2024 = 2023-24 season)
- **Output Path**: `/basketball_reference/season_rosters/{season}/{teamAbbr}.json`
- **Schedule**: Backfill workflows (historical collection) + Quarterly maintenance
- **Purpose**: Historical NBA team rosters for enhanced name mapping in NBA Gamebook PDFs
- **API Details**: HTML scraping with 3.5-second rate limiting (respects 20 req/min limit)
- **Dependencies**: None (independent collection)
- **Special Features**: 
  - **Complete Player Names**: "Morant" → "Ja Morant" for gamebook PDF enhancement
  - **Last Name Extraction**: Essential for NBA.com gamebook inactive player mapping
  - **Season Organization**: Files organized by season for easy lookup
  - **Proxy Integration**: Uses Proxy Fuel rotating proxies for reliability
- **Technical Requirements**: BeautifulSoup4 for HTML parsing, respects robots.txt
- **Collection Scope**: 120 roster files (30 teams × 4 seasons: 2022-2025)
- **Business Value**: Improves `GetNbaComGamebooks` accuracy by resolving incomplete player names
- **Maintenance**: Quarterly updates during NBA season for roster changes

### **Basketball Reference Rate Limits**
- **Rate Limit**: 20 requests per minute with 3-second crawl delay (per robots.txt)
- **Authentication**: None required
- **Data Format**: HTML parsing to structured JSON
- **Reliability**: Stable historical data, respectful scraping practices

---

## Backfill Strategy Summary

### **Phase 1: NBA Schedules** ✅ **COMPLETE**
- **Scraper**: `GetNbaComScheduleApi`
- **Status**: 5,583 games collected (2021-2024 seasons)
- **Storage**: `gs://nba-scraped-data/nba-com/schedule/{season}/`
- **Success**: Proven infrastructure and deployment patterns

### **Phase 2: NBA Game Books** 📋 **PLANNED**
- **Primary Scraper**: `GetNbaComGamebooks` (to be implemented)
- **Supporting Scraper**: `BasketballRefSeasonRoster` ✅ **COMPLETE** (120 roster files collected)
- **Scope**: ~173,000 player records with DNP context + enhanced name mapping
- **Strategy**: PDF processing of official NBA game books with Basketball Reference name lookup
- **Benefits**: Complete box scores + DNP reasons + accurate inactive player identification
- **Enhancement**: Basketball Reference rosters resolve "Morant" → "Ja Morant" for inactive players
- **Challenges**: PDF parsing complexity, format variations, name disambiguation
- **Mitigation**: Roster-based name mapping reduces parsing ambiguity

### **🆕 Phase 3: Historical Props** 📋 **READY FOR DEPLOYMENT**
- **Primary Scrapers**: `BettingProsEvents` + `BettingProsPlayerProps` ✅ **BUILT & TESTED**
- **Coverage**: October 2021 → May 2023 (~18 months of historical prop data)
- **Scope**: ~600 dates × ~40 props = **~24,000 historical prop bets**
- **Strategy**: Rate-limited API collection with automatic pagination consolidation
- **Benefits**: Fill critical gap before Odds API availability, complete sportsbook line history
- **Market Focus**: Points props (primary), other markets (optional)
- **Runtime**: ~2.5 hours total with respectful rate limiting
- **Dependencies**: Sequential (Events → Props, same pattern as Odds API)
- **Resumable**: Skip dates already in GCS, process by month/season chunks

### **Phase 4: Historical Props Extension** 📋 **FUTURE**
- **Scrapers**: Historical Odds API endpoints (if available)
- **Depends**: Phase 3 completion and API cost analysis

---

## Operational Schedules

### **Morning Operations** (Daily at 8 AM PT)
- `GetNbaComPlayerMovement` (1 request)
- `GetNbaComScheduleApi` (1 request) + `GetNbaComScheduleCdn` (1 request)
- `GetNbaComPlayerList` (1 request)
- `GetNbaComInjuryReport` (1 request) + `BdlInjuriesScraper` (1 request)
- `BdlStandingsScraper` (1 request)
- `BdlActivePlayersScraper` (5-6 requests)
- **Total**: ~12-13 requests

### **Real-Time Business** (Every 2 hours, 8 AM - 8 PM PT)
- `GetOddsApiEvents` (1 request) → `GetOddsApiCurrentEventOdds` (varies by events)
- `GetNbaComPlayerList` (1 request)
- `GetNbaComInjuryReport` (1 request) + `BdlInjuriesScraper` (1 request)
- `BdlActivePlayersScraper` (5-6 requests)
- **Total per cycle**: ~9-10 requests × 7 cycles = ~63-70 requests

### **Post-Game Collection** (8 PM & 11 PM PT)
- `GetNbaComScoreboardV2` (1 request)
- `BdlBoxScoresScraper` (1 request)
- **Total per cycle**: 2 requests × 2 cycles = 4 requests

### **Late Night Recovery** (2 AM PT)
- `BigDataBallPbpScraper` (varies by games)
- `GetNbaComPlayByPlay` (varies by games)
- `BdlBoxScoresScraper` (1 request)
- **Total**: Variable based on games

### **Early Morning Final Check** (5 AM PT)
- `BigDataBallPbpScraper` (varies by games)
- `GetNbaComPlayByPlay` (varies by games)
- `BdlBoxScoresScraper` (1 request)
- `GetEspnScoreboard` (1 request) → `GetEspnBoxscore` (varies by games)
- **Total**: Variable based on games

### **🆕 Backfill Operations** (On-demand)
- `GetNbaComScheduleApi` (Phase 1 - ✅ Complete)
- `BasketballRefSeasonRoster` (Data Enhancement - ✅ Complete) 
- `GetNbaComGamebooks` (Phase 2 - 📋 Planned)
- **🆕 `BettingProsEvents`** (Phase 3A - 📋 Ready: ~600 requests × 2s = ~20 minutes)
- **🆕 `BettingProsPlayerProps`** (Phase 3B - 📋 Ready: ~600 dates × 4 pages × 2.5s = ~2.5 hours)
- **Total**: Variable based on historical scope

### **Quarterly Maintenance** (During NBA season)
- `BasketballRefSeasonRoster` (Roster updates for current season)
- **Total**: ~30 requests per quarter (1 per team)

### **🆕 Daily Total API Requests** (Updated)
- **Regular Day**: ~80-85 requests
- **Game Day**: ~100-120 requests (including variable game-based scrapers)
- **Backfill Day**: +Variable PDF processing requests + **🆕 BettingPros historical collection**
- **Quarterly Update**: +30 requests for roster maintenance

---

## Critical Dependencies

### **Revenue Critical (Business Stops on Failure)**
1. `GetOddsApiEvents` → `GetOddsApiCurrentEventOdds` (Real-Time Business workflow)

### **🆕 Historical Critical (Model Training Foundation)**
2. **🆕 `BettingProsEvents`** → **🆕 `BettingProsPlayerProps`** (Phase 3 Backfill workflow)

### **Data Dependencies (Backup Available)**
3. `GetEspnScoreboard` → `GetEspnBoxscore` (Early Morning Final Check workflow)

### **Backfill Dependencies**
4. Phase 1 Schedule Data → `GetNbaComGamebooks` (provides known game dates for PDF collection)
5. `BasketballRefSeasonRoster` → `GetNbaComGamebooks` (provides player name mapping for PDFs)

### **All Other Scrapers**
- Independent execution (system continues on individual failures)
- Multiple backup sources available
- Recovery opportunities across multiple workflows

---

## Backup & Monitoring Strategy

### **Dual-Source Data Collection**
- **Schedules**: NBA.com API (primary) vs CDN (backup/monitoring)
- **Injuries**: NBA.com official (primary) vs Ball Don't Lie (backup)
- **Play-by-Play**: BigDataBall enhanced (primary) vs NBA.com official (backup)
- **Players**: NBA.com official (primary) vs Ball Don't Lie (validation)
- **Box Scores**: NBA.com Game Books (comprehensive) vs Ball Don't Lie (stats-only backup)
- **🆕 Props**: Odds API (current) vs **🆕 BettingPros (historical pre-2023)**

### **🆕 Historical Data Coverage**
- **🆕 Current Props** (May 2023 → Present): Odds API (FanDuel + DraftKings)
- **🆕 Historical Props** (Oct 2021 → May 2023): BettingPros (Multi-sportsbook)
- **🆕 Combined Coverage**: ~3.5 years of complete prop betting data
- **🆕 Gap Filled**: 18-month historical period now covered

### **Data Enhancement Strategy**
- **Name Mapping**: Basketball Reference rosters provide full name lookup for NBA.com gamebook PDF processing
- **Historical Accuracy**: 4 seasons of roster data (2022-2025) support gamebook inactive player identification
- **Maintenance Schedule**: Quarterly roster updates to catch mid-season transactions and roster changes

### **Recovery Workflows**
- **Late Night Recovery** (2 AM PT): Core game data + enhanced analytics
- **Early Morning Final Check** (5 AM PT): Final attempt + ESPN backups
- **Multiple Opportunities**: Data collection spread across multiple time windows

### **🆕 Success Metrics** (Updated)
- **Scraper Success Rate**: >95% for all scrapers
- **Data Freshness**: <2 hours for critical data
- **Player Lookup Accuracy**: >95% match rate
- **API Usage**: Within rate limits
- **Dual-Source Validation**: <5% discrepancy between primary/backup sources
- **PDF Processing**: >95% successful game book extraction (Phase 2)
- **Name Mapping Accuracy**: >95% successful inactive player identification with Basketball Reference roster data
- **🆕 Historical Prop Coverage**: >95% successful collection across 2021-2023 period
- **🆕 BettingPros Rate Compliance**: 2.5s delays between API calls for respectful usage

---

## Troubleshooting Guide

### **Revenue Critical Failures**
- **Odds API Events Down**: Alert immediately, check API status, manual collection if needed
- **Odds API Props Down**: Verify Events API success, check event IDs, restart Props collection

### **🆕 Historical Backfill Failures**
- **🆕 BettingPros Events Down**: Check API status, verify date format (YYYY-MM-DD), restart with different date range
- **🆕 BettingPros Props Down**: Verify Events API success, check event ID format, test single event first
- **🆕 BettingPros Rate Limit**: Increase delays if 429 responses, check for proxy issues
- **🆕 BettingPros Pagination Corruption**: Skip corrupted pages (known issue on some final pages), continue with partial data

### **Data Quality Issues**
- **Schedule Discrepancies**: Compare NBA.com API vs CDN, validate game counts
- **Injury Report Mismatches**: Cross-reference NBA.com vs Ball Don't Lie data
- **Player Lookup Failures**: Check both NBA.com and Ball Don't Lie player databases
- **Name Mapping Failures**: Verify Basketball Reference roster data availability, check season coverage
- **🆕 Historical Prop Discrepancies**: Compare BettingPros vs Odds API overlap period (May 2023)

### **Backfill Issues**
- **PDF Processing Failures**: Check format changes, verify URL patterns, test parsing logic
- **Game Book Missing**: Verify game date exists, check alternate URL formats
- **DNP Data Missing**: Cross-reference with injury reports, validate extraction logic
- **Roster Data Outdated**: Run quarterly Basketball Reference updates, verify team abbreviations
- **🆕 BettingPros Date Missing**: Verify NBA game occurred on date, check for postponements/cancellations
- **🆕 BettingPros Empty Response**: API returns no props for some dates (normal), log and continue

### **Authentication/Rate Limit Issues**
- **Ball Don't Lie**: Check `BDL_API_KEY`, monitor 600/minute limit, note Active Players uses 5-6 requests
- **Odds API**: Monitor monthly quota (500 requests), prioritize revenue-critical endpoints
- **BigDataBall**: Verify Google Drive service account access, check file availability
- **Basketball Reference**: Respect 20 req/min limit, monitor for 429 rate limit responses
- **🆕 BettingPros**: No authentication required, respect 10 items/page limit, monitor for encoding issues

### **🆕 Emergency Procedures** (Updated)
- **Primary Source Down**: Workflows automatically attempt backup sources
- **Complete Workflow Failure**: Data recovery available in subsequent workflow windows
- **Critical Business Impact**: Manual intervention protocols for revenue-affecting failures
- **Backfill Failure**: Fall back to BDL box scores without DNP context if PDF processing fails
- **Name Mapping Failure**: Fall back to incomplete player names if Basketball Reference unavailable
- **🆕 Historical Props Gap**: Use BettingPros for 2021-2023, Odds API for 2023-present
- **🆕 BettingPros Corruption**: Skip problematic dates/pages, resume collection, manual review if needed

---

## File and URL References

### **Repository Structure**
```
scrapers/
├── oddsapi/              # Odds API scrapers (revenue critical)
├── bettingpros/          # 🆕 BettingPros scrapers (historical backfill)
│   ├── bp_events.py      # 🆕 Historical game events
│   └── bp_player_props.py # 🆕 Historical prop betting lines
├── nbacom/               # NBA.com scrapers (official data)
│   ├── nbac_gamebooks.py # 📋 Game books scraper (Phase 2)
│   └── ...
├── balldontlie/          # Ball Don't Lie scrapers (validation/backup)
├── bigdataball/          # BigDataBall integration (enhanced analytics)
├── espn/                 # ESPN scrapers (backup only)
├── basketball_ref/       # Basketball Reference scrapers (data enhancement)
│   └── br_season_roster.py # Season rosters for name mapping
└── utils/                # Shared utilities
```

### **Scripts Structure**
```
scripts/
├── scrape_br_season_rosters.py  # Basketball Reference backfill script
└── 🆕 TBD: bettingpros_backfill_job.py  # 🆕 BettingPros Cloud Run backfill
```

### **Cloud Run Service**: `nba-scrapers-756957797294.us-west2.run.app`

---

## Quick Reference Summary

### **🆕 Most Critical Scrapers** (Updated)
1. `GetOddsApiEvents` - Foundation for all prop betting
2. `GetOddsApiCurrentEventOdds` - Core business revenue
3. `GetNbaComPlayerList` - Player team assignments
4. `GetNbaComInjuryReport` - Player availability for props
5. `GetNbaComGamebooks` - Historical box scores with DNP context (backfill)
6. `BasketballRefSeasonRoster` - Name mapping enhancement for gamebooks (backfill support)
7. **🆕 `BettingProsEvents`** - Historical game events (2021-2023 backfill foundation)
8. **🆕 `BettingProsPlayerProps`** - Historical prop betting lines (2021-2023 backfill)

### **Daily Operations**
- **Morning Setup**: 8 scrapers, ~12-13 API requests
- **Real-Time Business**: 6 scrapers, 7 cycles, ~63-70 API requests
- **Post-Game**: 2 scrapers, 2 cycles, 4 API requests
- **Recovery**: Variable scrapers based on games

### **🆕 Backfill Operations** (Updated)
- **Phase 1 Complete**: 5,583 historical games
- **Phase 2 Planned**: NBA game books with DNP reasons + Basketball Reference name mapping
- **🆕 Phase 3 Ready**: BettingPros historical props (2021-2023, ~24k prop bets)
- **PDF Processing**: High complexity, high value, enhanced by roster data
- **🆕 Historical Props**: High value, production-ready, fills critical data gap
- **Data Enhancement**: 120 roster files supporting improved name mapping accuracy

### **🆕 Backup Strategy** (Updated)
- **Dual-source monitoring** for schedules, injuries, and player data
- **Multiple recovery windows** for game data collection
- **ESPN as final backup** for scoreboard/boxscore data
- **Game books as comprehensive source** for historical box scores with context
- **Basketball Reference rosters** for enhanced name mapping and data quality
- **🆕 Dual-era prop coverage**: Odds API (current) + BettingPros (historical)
- **🆕 Complete prop timeline**: October 2021 → Present (~3.5 years)

This operational reference provides all practical details needed for day-to-day scraper management, deployment, and troubleshooting based on actual production workflows, including the new BettingPros scrapers for historical prop betting data collection.
