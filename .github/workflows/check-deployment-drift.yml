name: Check Deployment Drift

on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily
  workflow_dispatch:

jobs:
  check-drift:
    name: Check Deployment Drift
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git log comparisons

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check deployment drift
        id: drift-check
        run: |
          # Run drift check and capture output
          ./bin/check-deployment-drift.sh --verbose > drift_report.txt 2>&1 || true
          cat drift_report.txt

          # Parse for stale services
          STALE_SERVICES=$(grep -E "^❌.*STALE DEPLOYMENT" drift_report.txt | sed 's/❌ //' | sed 's/: STALE DEPLOYMENT//' || true)

          if [ -z "$STALE_SERVICES" ]; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "::notice::All services are up to date!"
          else
            echo "drift_detected=true" >> $GITHUB_OUTPUT

            # Count stale services
            STALE_COUNT=$(echo "$STALE_SERVICES" | wc -l)
            echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT

            # Store service list (newline-separated -> comma-separated for summary)
            STALE_LIST=$(echo "$STALE_SERVICES" | tr '\n' ',' | sed 's/,$//')
            echo "stale_services=$STALE_LIST" >> $GITHUB_OUTPUT

            echo "::warning::Found $STALE_COUNT service(s) with deployment drift: $STALE_LIST"
          fi

          # Save full report for issue body
          {
            echo 'drift_report<<EOF'
            cat drift_report.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Check for existing drift issue
        id: check-existing
        if: steps.drift-check.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open deployment-drift issue
          EXISTING_ISSUE=$(gh issue list --label "deployment-drift" --state open --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "existing_issue=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
            echo "::notice::Found existing drift issue #$EXISTING_ISSUE"
          else
            echo "existing_issue=" >> $GITHUB_OUTPUT
          fi

      - name: Create or update drift issue
        if: steps.drift-check.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STALE_SERVICES: ${{ steps.drift-check.outputs.stale_services }}
          STALE_COUNT: ${{ steps.drift-check.outputs.stale_count }}
          DRIFT_REPORT: ${{ steps.drift-check.outputs.drift_report }}
          EXISTING_ISSUE: ${{ steps.check-existing.outputs.existing_issue }}
        run: |
          # Build issue body
          ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ## Deployment Drift Detected

          **${{ steps.drift-check.outputs.stale_count }} service(s)** have code changes that haven't been deployed.

          ### Stale Services

          ISSUE_EOF
          )

          # Add each stale service as a checkbox
          for service in $(echo "$STALE_SERVICES" | tr ',' '\n'); do
            ISSUE_BODY="$ISSUE_BODY
          - [ ] \`$service\`"
          done

          ISSUE_BODY="$ISSUE_BODY

          ### Full Drift Report

          \`\`\`
          $DRIFT_REPORT
          \`\`\`

          ### Resolution

          Deploy the stale services using the appropriate deployment scripts:

          \`\`\`bash
          # Example for prediction-worker
          ./bin/deploy-prediction-worker.sh

          # Or use the general deployment script
          ./bin/deploy-cloud-run.sh <service-name>
          \`\`\`

          ### Context

          - **Detected**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Workflow run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *This issue was automatically created by the deployment drift check workflow.*
          "

          if [ -n "$EXISTING_ISSUE" ]; then
            # Update existing issue with new comment
            gh issue comment "$EXISTING_ISSUE" --body "## Updated Drift Report ($(date -u '+%Y-%m-%d %H:%M UTC'))

          Still detecting drift in **$STALE_COUNT** service(s): \`$STALE_SERVICES\`

          <details>
          <summary>Full Report</summary>

          \`\`\`
          $DRIFT_REPORT
          \`\`\`

          </details>

          [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

            echo "::notice::Updated existing issue #$EXISTING_ISSUE with new drift report"
          else
            # Create new issue
            gh issue create \
              --title "Deployment Drift: $STALE_COUNT service(s) behind" \
              --body "$ISSUE_BODY" \
              --label "deployment-drift"

            echo "::notice::Created new deployment drift issue"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Drift Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.drift-check.outputs.drift_detected }}" == "true" ]; then
            echo "### :warning: Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.drift-check.outputs.stale_count }}** service(s) have unpushed code changes:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for service in $(echo "${{ steps.drift-check.outputs.stale_services }}" | tr ',' '\n'); do
              echo "- \`$service\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub issue has been created/updated with details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### :white_check_mark: All Services Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No deployment drift detected. All services are running the latest code." >> $GITHUB_STEP_SUMMARY
          fi
