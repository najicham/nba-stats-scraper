name: CD - Auto Deploy on Main

on:
  push:
    branches: [main]
    paths:
      - 'scrapers/**'
      - 'data_processors/**'
      - 'predictions/**'
      - 'shared/**'
      - 'orchestration/**'
      - 'requirements*.txt'

  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all services regardless of changes'
        type: boolean
        default: false
      service:
        description: 'Deploy a specific service (optional)'
        type: choice
        options:
          - ''
          - nba-scrapers
          - nba-phase2-raw-processors
          - nba-phase3-analytics-processors
          - nba-phase4-precompute-processors
          - prediction-coordinator
          - prediction-worker
          - nba-grading-service

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      scrapers: ${{ steps.changes.outputs.scrapers }}
      phase2: ${{ steps.changes.outputs.phase2 }}
      phase3: ${{ steps.changes.outputs.phase3 }}
      phase4: ${{ steps.changes.outputs.phase4 }}
      coordinator: ${{ steps.changes.outputs.coordinator }}
      worker: ${{ steps.changes.outputs.worker }}
      grading: ${{ steps.changes.outputs.grading }}
      any_service: ${{ steps.changes.outputs.any_service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        env:
          DEPLOY_ALL: ${{ github.event.inputs.deploy_all }}
          DEPLOY_SERVICE: ${{ github.event.inputs.service }}
        run: |
          # Get changed files
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files:"
          echo "$CHANGED"

          # Check for shared changes (triggers all services)
          SHARED=false
          if echo "$CHANGED" | grep -q '^shared/'; then
            SHARED=true
            echo "shared/ changed - all services need deploy"
          fi

          # Determine which services need deployment
          deploy_scrapers=false
          deploy_phase2=false
          deploy_phase3=false
          deploy_phase4=false
          deploy_coordinator=false
          deploy_worker=false
          deploy_grading=false

          if [ "$DEPLOY_ALL" = "true" ] || [ "$SHARED" = "true" ]; then
            deploy_scrapers=true
            deploy_phase2=true
            deploy_phase3=true
            deploy_phase4=true
            deploy_coordinator=true
            deploy_worker=true
            deploy_grading=true
          else
            # Check individual service paths
            echo "$CHANGED" | grep -q '^scrapers/' && deploy_scrapers=true
            echo "$CHANGED" | grep -q '^data_processors/raw/' && deploy_phase2=true
            echo "$CHANGED" | grep -q '^data_processors/analytics/' && deploy_phase3=true
            echo "$CHANGED" | grep -q '^data_processors/precompute/' && deploy_phase4=true
            echo "$CHANGED" | grep -q '^predictions/coordinator/' && deploy_coordinator=true
            echo "$CHANGED" | grep -q '^predictions/worker/' && deploy_worker=true
            echo "$CHANGED" | grep -q '^data_processors/grading/' && deploy_grading=true
            # Generic predictions/ changes deploy both coordinator and worker
            if echo "$CHANGED" | grep -q '^predictions/shared/'; then
              deploy_coordinator=true
              deploy_worker=true
              deploy_grading=true
            fi
          fi

          # Override for specific service deployment
          if [ -n "$DEPLOY_SERVICE" ]; then
            deploy_scrapers=false; deploy_phase2=false; deploy_phase3=false
            deploy_phase4=false; deploy_coordinator=false; deploy_worker=false; deploy_grading=false
            case "$DEPLOY_SERVICE" in
              nba-scrapers) deploy_scrapers=true ;;
              nba-phase2-raw-processors) deploy_phase2=true ;;
              nba-phase3-analytics-processors) deploy_phase3=true ;;
              nba-phase4-precompute-processors) deploy_phase4=true ;;
              prediction-coordinator) deploy_coordinator=true ;;
              prediction-worker) deploy_worker=true ;;
              nba-grading-service) deploy_grading=true ;;
            esac
          fi

          # Set outputs
          echo "scrapers=$deploy_scrapers" >> $GITHUB_OUTPUT
          echo "phase2=$deploy_phase2" >> $GITHUB_OUTPUT
          echo "phase3=$deploy_phase3" >> $GITHUB_OUTPUT
          echo "phase4=$deploy_phase4" >> $GITHUB_OUTPUT
          echo "coordinator=$deploy_coordinator" >> $GITHUB_OUTPUT
          echo "worker=$deploy_worker" >> $GITHUB_OUTPUT
          echo "grading=$deploy_grading" >> $GITHUB_OUTPUT

          any=false
          [ "$deploy_scrapers" = "true" ] || [ "$deploy_phase2" = "true" ] || \
          [ "$deploy_phase3" = "true" ] || [ "$deploy_phase4" = "true" ] || \
          [ "$deploy_coordinator" = "true" ] || [ "$deploy_worker" = "true" ] || \
          [ "$deploy_grading" = "true" ] && any=true
          echo "any_service=$any" >> $GITHUB_OUTPUT

          echo ""
          echo "Services to deploy:"
          [ "$deploy_scrapers" = "true" ] && echo "  - nba-scrapers" || true
          [ "$deploy_phase2" = "true" ] && echo "  - nba-phase2-raw-processors" || true
          [ "$deploy_phase3" = "true" ] && echo "  - nba-phase3-analytics-processors" || true
          [ "$deploy_phase4" = "true" ] && echo "  - nba-phase4-precompute-processors" || true
          [ "$deploy_coordinator" = "true" ] && echo "  - prediction-coordinator" || true
          [ "$deploy_worker" = "true" ] && echo "  - prediction-worker" || true
          [ "$deploy_grading" = "true" ] && echo "  - nba-grading-service" || true
          [ "$any" = "false" ] && echo "  (none - no service changes detected)" || true

  # Each service deploys as a separate job for parallelism and independent failure
  deploy-scrapers:
    needs: detect-changes
    if: needs.detect-changes.outputs.scrapers == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: nba-scrapers
      dockerfile: scrapers/Dockerfile
    secrets: inherit

  deploy-phase2:
    needs: detect-changes
    if: needs.detect-changes.outputs.phase2 == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: nba-phase2-raw-processors
      dockerfile: data_processors/raw/Dockerfile
    secrets: inherit

  deploy-phase3:
    needs: detect-changes
    if: needs.detect-changes.outputs.phase3 == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: nba-phase3-analytics-processors
      dockerfile: data_processors/analytics/Dockerfile
    secrets: inherit

  deploy-phase4:
    needs: detect-changes
    if: needs.detect-changes.outputs.phase4 == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: nba-phase4-precompute-processors
      dockerfile: data_processors/precompute/Dockerfile
    secrets: inherit

  deploy-coordinator:
    needs: detect-changes
    if: needs.detect-changes.outputs.coordinator == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: prediction-coordinator
      dockerfile: predictions/coordinator/Dockerfile
    secrets: inherit

  deploy-worker:
    needs: detect-changes
    if: needs.detect-changes.outputs.worker == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: prediction-worker
      dockerfile: predictions/worker/Dockerfile
    secrets: inherit

  deploy-grading:
    needs: detect-changes
    if: needs.detect-changes.outputs.grading == 'true'
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: nba-grading-service
      dockerfile: data_processors/grading/nba/Dockerfile
    secrets: inherit

  summary:
    needs: [detect-changes, deploy-scrapers, deploy-phase2, deploy-phase3, deploy-phase4, deploy-coordinator, deploy-worker, deploy-grading]
    if: always() && needs.detect-changes.outputs.any_service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "## Auto-Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          report_status() {
            local name=$1
            local result=$2
            local needed=$3
            if [ "$needed" != "true" ]; then
              echo "| $name | Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
            elif [ "$result" = "success" ]; then
              echo "| $name | Deployed |" >> $GITHUB_STEP_SUMMARY
            elif [ "$result" = "skipped" ]; then
              echo "| $name | Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $name | FAILED |" >> $GITHUB_STEP_SUMMARY
            fi
          }

          report_status "nba-scrapers" "${{ needs.deploy-scrapers.result }}" "${{ needs.detect-changes.outputs.scrapers }}"
          report_status "nba-phase2-raw-processors" "${{ needs.deploy-phase2.result }}" "${{ needs.detect-changes.outputs.phase2 }}"
          report_status "nba-phase3-analytics-processors" "${{ needs.deploy-phase3.result }}" "${{ needs.detect-changes.outputs.phase3 }}"
          report_status "nba-phase4-precompute-processors" "${{ needs.deploy-phase4.result }}" "${{ needs.detect-changes.outputs.phase4 }}"
          report_status "prediction-coordinator" "${{ needs.deploy-coordinator.result }}" "${{ needs.detect-changes.outputs.coordinator }}"
          report_status "prediction-worker" "${{ needs.deploy-worker.result }}" "${{ needs.detect-changes.outputs.worker }}"
          report_status "nba-grading-service" "${{ needs.deploy-grading.result }}" "${{ needs.detect-changes.outputs.grading }}"
